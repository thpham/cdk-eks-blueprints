"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.FluxCDAddOn = void 0;
const ts_deepmerge_1 = require("ts-deepmerge");
const utils_1 = require("../../utils");
const helm_addon_1 = require("../helm-addon");
const gitrepository_1 = require("./gitrepository");
const kustomization_1 = require("./kustomization");
/**
 * Default props to be used when creating the Helm chart
 */
const defaultProps = {
    name: "fluxcd-addon",
    namespace: "flux-system",
    chart: "flux2",
    version: "2.12.4",
    release: "blueprints-fluxcd-addon",
    repository: "https://fluxcd-community.github.io/helm-charts",
    values: {},
    createNamespace: true,
};
const defaultRepoProps = {
    syncInterval: "5m0s",
};
const defaultKustomiationProps = {
    kustomizationPath: ".",
    syncInterval: "5m0s",
    prune: true,
    timeout: "1m",
};
/**
 * Main class to instantiate the Helm chart
 */
let FluxCDAddOn = class FluxCDAddOn extends helm_addon_1.HelmAddOn {
    constructor(props) {
        super({ ...defaultProps, ...props });
        this.options = this.props;
    }
    deploy(clusterInfo) {
        var _a, _b;
        const cluster = clusterInfo.cluster;
        let values = (_a = this.options.values) !== null && _a !== void 0 ? _a : {};
        values = (0, ts_deepmerge_1.merge)(values, (_b = this.props.values) !== null && _b !== void 0 ? _b : {});
        const chart = this.addHelmChart(clusterInfo, values);
        if (this.options.createNamespace == true) {
            // Let CDK Create the Namespace
            const namespace = (0, utils_1.createNamespace)(this.options.namespace, cluster);
            chart.node.addDependency(namespace);
        }
        //Create GitRepository sources and Kustomizations
        if (this.options.repositories) {
            this.options.repositories.map((repo) => {
                repo = { ...defaultRepoProps, ...repo };
                const gitRepositoryConstruct = createGitRepository(clusterInfo, this.options.name, this.options.namespace, repo);
                gitRepositoryConstruct.node.addDependency(chart);
                const kustomizationConstructs = createKustomizations(clusterInfo, this.options.name, this.options.namespace, repo);
                kustomizationConstructs.map(kustomizationConstruct => kustomizationConstruct.node.addDependency(gitRepositoryConstruct));
            });
        }
        return Promise.resolve(chart);
    }
};
exports.FluxCDAddOn = FluxCDAddOn;
exports.FluxCDAddOn = FluxCDAddOn = __decorate([
    utils_1.supportsALL
], FluxCDAddOn);
/**
 * create GitRepository calls the FluxGitRepository().generate to create GitRepostory resource.
 */
function createGitRepository(clusterInfo, name, namespace, fluxGitRepo) {
    var _a;
    if (fluxGitRepo.repository === undefined) {
        throw new Error("Missing Git repository");
    }
    const manifest = new gitrepository_1.FluxGitRepository(fluxGitRepo.repository).generate(fluxGitRepo.name, (_a = fluxGitRepo.namespace) !== null && _a !== void 0 ? _a : namespace, fluxGitRepo.syncInterval, fluxGitRepo.secretRefName);
    let manifestName = name + 'gitrepository' + fluxGitRepo.name;
    const construct = clusterInfo.cluster.addManifest(manifestName, manifest);
    return construct;
}
/**
 * create Kustomizations calls the FluxKustomization().generate multiple times to create Kustomization resources.
 */
function createKustomizations(clusterInfo, name, namespace, fluxGitRepo) {
    var _a;
    const constructs = [];
    const kustomizations = (_a = fluxGitRepo.kustomizations) !== null && _a !== void 0 ? _a : [{ kustomizationPath: "." }];
    const fluxKustomization = new kustomization_1.FluxKustomization();
    kustomizations === null || kustomizations === void 0 ? void 0 : kustomizations.map((kustomization, index) => {
        var _a;
        kustomization = { ...defaultKustomiationProps, ...kustomization };
        const manifest = fluxKustomization.generate(fluxGitRepo.name + "-" + index, fluxGitRepo.name, (_a = fluxGitRepo.namespace) !== null && _a !== void 0 ? _a : namespace, kustomization.syncInterval, kustomization.prune, kustomization.timeout, fluxGitRepo.values, kustomization.kustomizationPath, kustomization.kustomizationTargetNamespace);
        let manifestName = name + 'kustomization' + fluxGitRepo.name + index;
        constructs.push(clusterInfo.cluster.addManifest(manifestName, manifest));
    });
    return constructs;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvYWRkb25zL2ZsdXhjZC9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFFQSwrQ0FBcUM7QUFHckMsdUNBQTJEO0FBQzNELDhDQUE4RTtBQUM5RSxtREFBb0Q7QUFDcEQsbURBQW9EO0FBa0ZwRDs7R0FFRztBQUNILE1BQU0sWUFBWSxHQUFzQztJQUN0RCxJQUFJLEVBQUUsY0FBYztJQUNwQixTQUFTLEVBQUUsYUFBYTtJQUN4QixLQUFLLEVBQUUsT0FBTztJQUNkLE9BQU8sRUFBRSxRQUFRO0lBQ2pCLE9BQU8sRUFBRSx5QkFBeUI7SUFDbEMsVUFBVSxFQUFFLGdEQUFnRDtJQUM1RCxNQUFNLEVBQUUsRUFBRTtJQUNWLGVBQWUsRUFBRSxJQUFJO0NBQ3RCLENBQUM7QUFFRixNQUFNLGdCQUFnQixHQUF5QjtJQUMzQyxZQUFZLEVBQUUsTUFBTTtDQUN2QixDQUFDO0FBRUYsTUFBTSx3QkFBd0IsR0FBMkI7SUFDckQsaUJBQWlCLEVBQUUsR0FBRztJQUN0QixZQUFZLEVBQUUsTUFBTTtJQUNwQixLQUFLLEVBQUUsSUFBSTtJQUNYLE9BQU8sRUFBRSxJQUFJO0NBQ2hCLENBQUM7QUFFRjs7R0FFRztBQUVJLElBQU0sV0FBVyxHQUFqQixNQUFNLFdBQVksU0FBUSxzQkFBUztJQUl4QyxZQUFZLEtBQXdCO1FBQ2xDLEtBQUssQ0FBQyxFQUFDLEdBQUcsWUFBWSxFQUFFLEdBQUcsS0FBSyxFQUFDLENBQUMsQ0FBQztRQUNuQyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxLQUF5QixDQUFDO0lBQ2hELENBQUM7SUFFRCxNQUFNLENBQUMsV0FBd0I7O1FBQzdCLE1BQU0sT0FBTyxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUM7UUFDcEMsSUFBSSxNQUFNLEdBQVcsTUFBQSxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sbUNBQUksRUFBRSxDQUFD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QUcsRUFBQyxDQUFDLENBQUM7SUFDaEYsTUFBTSxpQkFBaUIsR0FBRyxJQUFJLGlDQUFpQixFQUFFLENBQUM7SUFDbEQsY0FBYyxhQUFkLGNBQWMsdUJBQWQsY0FBYyxDQUFFLEdBQUcsQ0FBQyxDQUFDLGFBQWEsRUFBRSxLQUFLLEVBQUUsRUFBRTs7UUFDM0MsYUFBYSxHQUFHLEVBQUMsR0FBRyx3QkFBd0IsRUFBRSxHQUFHLGFBQWEsRUFBQyxDQUFDO1FBQ2hFLE1BQU0sUUFBUSxHQUFFLGlCQUFpQixDQUFDLFFBQVEsQ0FDeEMsV0FBVyxDQUFDLElBQUksR0FBRyxHQUFHLEdBQUcsS0FBSyxFQUM5QixXQUFXLENBQUMsSUFBSSxFQUNoQixNQUFBLFdBQVcsQ0FBQyxTQUFTLG1DQUFJLFNBQVMsRUFDbEMsYUFBYSxDQUFDLFlBQWEsRUFDM0IsYUFBYSxDQUFDLEtBQU0sRUFDcEIsYUFBYSxDQUFDLE9BQVEsRUFDdEIsV0FBVyxDQUFDLE1BQU0sRUFDbEIsYUFBYSxDQUFDLGlCQUFpQixFQUMvQixhQUFhLENBQUMsNEJBQTRCLENBQzNDLENBQUM7UUFDRixJQUFJLFlBQVksR0FBdUIsSUFBSSxHQUFHLGVBQWUsR0FBRSxXQUFXLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQztRQUN4RixVQUFVLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLFlBQWEsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDO0lBRTVFLENBQUMsQ0FBQyxDQUFDO0lBRUgsT0FBTyxVQUFVLENBQUM7QUFDcEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIGxpYi9mbHV4Y2RfYWRkb24udHNcclxuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XHJcbmltcG9ydCB7IG1lcmdlIH0gZnJvbSBcInRzLWRlZXBtZXJnZVwiO1xyXG5pbXBvcnQgKiBhcyBzcGkgZnJvbSBcIi4uLy4uL3NwaVwiO1xyXG5pbXBvcnQgeyBDbHVzdGVySW5mbywgVmFsdWVzIH0gZnJvbSBcIi4uLy4uL3NwaVwiO1xyXG5pbXBvcnQgeyBjcmVhdGVOYW1lc3BhY2UsIHN1cHBvcnRzQUxMIH0gZnJvbSBcIi4uLy4uL3V0aWxzXCI7XHJcbmltcG9ydCB7IEhlbG1BZGRPbiwgSGVsbUFkZE9uUHJvcHMsIEhlbG1BZGRPblVzZXJQcm9wcyB9IGZyb20gXCIuLi9oZWxtLWFkZG9uXCI7XHJcbmltcG9ydCB7IEZsdXhHaXRSZXBvc2l0b3J5IH0gZnJvbSBcIi4vZ2l0cmVwb3NpdG9yeVwiO1xyXG5pbXBvcnQgeyBGbHV4S3VzdG9taXphdGlvbiB9IGZyb20gXCIuL2t1c3RvbWl6YXRpb25cIjtcclxuaW1wb3J0IHsgS3ViZXJuZXRlc01hbmlmZXN0IH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWVrcy9saWIvazhzLW1hbmlmZXN0JztcclxuXHJcbi8qKlxyXG4gKiBPcHRpb25zIGZvciBhIEZsdXhDRCBHaXRSZXBvc2l0b3J5XHJcbiAqIHBhdGggYW5kIG5hbWUgcGFyYW1ldGVyIHdpdGhpbiByZXBvc2l0b3J5IHBhcmFtZXRlciBkbyBub3QgaGF2ZSBhbnkgYWZmZWN0IGluIGZsdXgsIG1heSBoYXZlIGFuIGFmZmVjdCBpbiBhcmdvXHJcbiAqL1xyXG5leHBvcnQgaW50ZXJmYWNlIEZsdXhHaXRSZXBvIGV4dGVuZHMgUmVxdWlyZWQ8c3BpLkdpdE9wc0FwcGxpY2F0aW9uRGVwbG95bWVudD4ge1xyXG4gIC8qKiBcclxuICAqIEZsdXggU2VjcmV0UmVmICovXHJcbiAgc2VjcmV0UmVmTmFtZT86IHN0cmluZztcclxuXHJcbiAgLyoqIFxyXG4gICogSW50ZXJuYWwgZm9yIEZsdXggc3luYy5cclxuICAqIERlZmF1bHQgYDVtMHNgICovXHJcbiAgc3luY0ludGVydmFsPzogc3RyaW5nO1xyXG5cclxuICAvKipcclxuICAqIExpc3Qgb2Yga3VzdG9taXphdGlvbnMgdG8gY3JlYXRlIGZyb20gZGlmZmVyZW50IHBhdGhzIGluIHJlcG8uICovXHJcbiAga3VzdG9taXphdGlvbnM/OiBGbHV4S3VzdG9taXphdGlvblByb3BzW107XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgRmx1eEt1c3RvbWl6YXRpb25Qcm9wcyB7XHJcbiAgICAvKipcclxuICAgICAqIEZsdXggS3VzdG9taXphdGlvbiBwYXRoIHdpdGhpbiB0aGUgR2l0UmVwb3NpdG9yeSBcclxuICAgICAqIERvIG5vdCB1c2UgdGhlIHBhdGggaW4gdGhlIHJlcG9zaXRvcnkgZmllbGQqL1xyXG4gICAga3VzdG9taXphdGlvblBhdGg6IHN0cmluZztcclxuXHJcbiAgICAvKiogXHJcbiAgICAqIEZsdXggS3VzdG9taXphdGlvbiBUYXJnZXQgTmFtZXNwYWNlLlxyXG4gICAgKiBOb3RlOiB3aGVuIHNldCwgdGhpcyBwYXJhbWV0ZXIgd2lsbCBvdmVycmlkZSBhbGwgdGhlIG9iamVjdHMgdGhhdCBhcmUgcGFydCBvZiB0aGUgS3VzdG9taXphdGlvbiwgcGxlYXNlIHNlZSBodHRwczovL2ZsdXhjZC5pby9mbHV4L2NvbXBvbmVudHMva3VzdG9taXplL2t1c3RvbWl6YXRpb24vI3RhcmdldC1uYW1lc3BhY2UgKi9cclxuICAgIGt1c3RvbWl6YXRpb25UYXJnZXROYW1lc3BhY2U/OiBzdHJpbmc7XHJcblxyXG4gICAgLyoqIFxyXG4gICAgKiBJbnRlcm5hbCBmb3IgRmx1eCBzeW5jLlxyXG4gICAgKiBEZWZhdWx0IGA1bTBzYCAqL1xyXG4gICAgc3luY0ludGVydmFsPzogc3RyaW5nO1xyXG5cclxuICAgIC8qKiBcclxuICAgICogRmx1eCBLdXN0b21pemF0aW9uIFBydW5lLlxyXG4gICAgKiBEZWZhdWx0IGB0cnVlYCAqL1xyXG4gICAgcHJ1bmU/OiBib29sZWFuO1xyXG5cclxuICAgIC8qKiBcclxuICAgICogRmx1eCBLdXN0b21pemF0aW9uIFRpbWVvdXQuXHJcbiAgICAqIERlZmF1bHQgYDFtYCAqL1xyXG4gICAgdGltZW91dD86IHN0cmluZztcclxufVxyXG5cclxuLyoqXHJcbiAqIFVzZXIgcHJvdmlkZWQgb3B0aW9ucyBmb3IgdGhlIEhlbG0gQ2hhcnRcclxuICovXHJcbmV4cG9ydCBpbnRlcmZhY2UgRmx1eENEQWRkT25Qcm9wcyBleHRlbmRzIEhlbG1BZGRPblVzZXJQcm9wcyB7XHJcblxyXG4gIC8qKlxyXG4gICAqIE5hbWVzcGFjZSB3aGVyZSBhZGQtb24gd2lsbCBiZSBkZXBsb3llZC4gXHJcbiAgICogQGRlZmF1bHQgZmx1eC1zeXN0ZW1cclxuICAgKi9cclxuICBuYW1lc3BhY2U/OiBzdHJpbmc7XHJcblxyXG4gIC8qKlxyXG4gICogSGVsbSBjaGFydCB2ZXJzaW9uIHRvIHVzZSB0byBpbnN0YWxsLlxyXG4gICogQGRlZmF1bHQgMi4xMi40XHJcbiAgKi9cclxuICB2ZXJzaW9uPzogc3RyaW5nO1xyXG5cclxuICAvKipcclxuICAgKiBWYWx1ZXMgdG8gcGFzcyB0byB0aGUgY2hhcnQgYXMgcGVyIGh0dHBzOi8vZ2l0aHViLmNvbS9hcmdvcHJvai9hcmdvLWhlbG0vYmxvYi9tYXN0ZXIvY2hhcnRzL2FyZ28tY2QvdmFsdWVzLnlhbWwuXHJcbiAgICovXHJcbiAgdmFsdWVzPzogc3BpLlZhbHVlcztcclxuXHJcbiAgLyoqXHJcbiAgICogVG8gQ3JlYXRlIE5hbWVzcGFjZSB1c2luZyBDREtcclxuICAgKi8gICAgXHJcbiAgY3JlYXRlTmFtZXNwYWNlPzogYm9vbGVhbjtcclxuXHJcbiAgLyoqXHJcbiAgICogTGlzdCBvZiByZXBvc2l0b3JpZXMgdG8gc3luYyBmcm9tLlxyXG4gICAqL1xyXG4gIHJlcG9zaXRvcmllcz86IEZsdXhHaXRSZXBvW107XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBEZWZhdWx0IHByb3BzIHRvIGJlIHVzZWQgd2hlbiBjcmVhdGluZyB0aGUgSGVsbSBjaGFydFxyXG4gKi9cclxuY29uc3QgZGVmYXVsdFByb3BzOiBIZWxtQWRkT25Qcm9wcyAmIEZsdXhDREFkZE9uUHJvcHMgPSB7XHJcbiAgbmFtZTogXCJmbHV4Y2QtYWRkb25cIixcclxuICBuYW1lc3BhY2U6IFwiZmx1eC1zeXN0ZW1cIixcclxuICBjaGFydDogXCJmbHV4MlwiLFxyXG4gIHZlcnNpb246IFwiMi4xMi40XCIsXHJcbiAgcmVsZWFzZTogXCJibHVlcHJpbnRzLWZsdXhjZC1hZGRvblwiLFxyXG4gIHJlcG9zaXRvcnk6IFwiaHR0cHM6Ly9mbHV4Y2QtY29tbXVuaXR5LmdpdGh1Yi5pby9oZWxtLWNoYXJ0c1wiLFxyXG4gIHZhbHVlczoge30sXHJcbiAgY3JlYXRlTmFtZXNwYWNlOiB0cnVlLFxyXG59O1xyXG5cclxuY29uc3QgZGVmYXVsdFJlcG9Qcm9wczogUGFydGlhbDxGbHV4R2l0UmVwbz4gPSB7XHJcbiAgICBzeW5jSW50ZXJ2YWw6IFwiNW0wc1wiLFxyXG59O1xyXG5cclxuY29uc3QgZGVmYXVsdEt1c3RvbWlhdGlvblByb3BzOiBGbHV4S3VzdG9taXphdGlvblByb3BzID0ge1xyXG4gICAga3VzdG9taXphdGlvblBhdGg6IFwiLlwiLFxyXG4gICAgc3luY0ludGVydmFsOiBcIjVtMHNcIixcclxuICAgIHBydW5lOiB0cnVlLFxyXG4gICAgdGltZW91dDogXCIxbVwiLFxyXG59O1xyXG5cclxuLyoqXHJcbiAqIE1haW4gY2xhc3MgdG8gaW5zdGFudGlhdGUgdGhlIEhlbG0gY2hhcnRcclxuICovXHJcbkBzdXBwb3J0c0FMTFxyXG5leHBvcnQgY2xhc3MgRmx1eENEQWRkT24gZXh0ZW5kcyBIZWxtQWRkT24ge1xyXG5cclxuICByZWFkb25seSBvcHRpb25zOiBGbHV4Q0RBZGRPblByb3BzO1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcm9wcz86IEZsdXhDREFkZE9uUHJvcHMpIHtcclxuICAgIHN1cGVyKHsuLi5kZWZhdWx0UHJvcHMsIC4uLnByb3BzfSk7XHJcbiAgICB0aGlzLm9wdGlvbnMgPSB0aGlzLnByb3BzIGFzIEZsdXhDREFkZE9uUHJvcHM7XHJcbiAgfVxyXG5cclxuICBkZXBsb3koY2x1c3RlckluZm86IENsdXN0ZXJJbmZvKTogUHJvbWlzZTxDb25zdHJ1Y3Q+IHtcclxuICAgIGNvbnN0IGNsdXN0ZXIgPSBjbHVzdGVySW5mby5jbHVzdGVyO1xyXG4gICAgbGV0IHZhbHVlczogVmFsdWVzID0gdGhpcy5vcHRpb25zLnZhbHVlcyA/PyB7fTtcclxuICAgIHZhbHVlcyA9IG1lcmdlKHZhbHVlcywgdGhpcy5wcm9wcy52YWx1ZXMgPz8ge30pO1xyXG4gICAgY29uc3QgY2hhcnQgPSB0aGlzLmFkZEhlbG1DaGFydChjbHVzdGVySW5mbywgdmFsdWVzKTtcclxuXHJcbiAgICBpZiggdGhpcy5vcHRpb25zLmNyZWF0ZU5hbWVzcGFjZSA9PSB0cnVlKXtcclxuICAgICAgLy8gTGV0IENESyBDcmVhdGUgdGhlIE5hbWVzcGFjZVxyXG4gICAgICBjb25zdCBuYW1lc3BhY2UgPSBjcmVhdGVOYW1lc3BhY2UodGhpcy5vcHRpb25zLm5hbWVzcGFjZSEgLCBjbHVzdGVyKTtcclxuICAgICAgY2hhcnQubm9kZS5hZGREZXBlbmRlbmN5KG5hbWVzcGFjZSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy9DcmVhdGUgR2l0UmVwb3NpdG9yeSBzb3VyY2VzIGFuZCBLdXN0b21pemF0aW9uc1xyXG4gICAgaWYgKHRoaXMub3B0aW9ucy5yZXBvc2l0b3JpZXMpIHtcclxuICAgICAgICB0aGlzLm9wdGlvbnMucmVwb3NpdG9yaWVzLm1hcCgocmVwbykgPT4ge1xyXG4gICAgICAgICAgICByZXBvID0gey4uLmRlZmF1bHRSZXBvUHJvcHMsIC4uLnJlcG99O1xyXG4gICAgICAgICAgICBjb25zdCBnaXRSZXBvc2l0b3J5Q29uc3RydWN0ID0gY3JlYXRlR2l0UmVwb3NpdG9yeShjbHVzdGVySW5mbywgdGhpcy5vcHRpb25zLm5hbWUhLCB0aGlzLm9wdGlvbnMubmFtZXNwYWNlISwgcmVwbyk7XHJcbiAgICAgICAgICAgIGdpdFJlcG9zaXRvcnlDb25zdHJ1Y3Qubm9kZS5hZGREZXBlbmRlbmN5KGNoYXJ0KTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGt1c3RvbWl6YXRpb25Db25zdHJ1Y3RzID0gY3JlYXRlS3VzdG9taXphdGlvbnMoY2x1c3RlckluZm8sIHRoaXMub3B0aW9ucy5uYW1lISwgdGhpcy5vcHRpb25zLm5hbWVzcGFjZSEsIHJlcG8pO1xyXG4gICAgICAgICAgICBrdXN0b21pemF0aW9uQ29uc3RydWN0cy5tYXAoa3VzdG9taXphdGlvbkNvbnN0cnVjdCA9PiBrdXN0b21pemF0aW9uQ29uc3RydWN0Lm5vZGUuYWRkRGVwZW5kZW5jeShnaXRSZXBvc2l0b3J5Q29uc3RydWN0KSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoY2hhcnQpO1xyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIGNyZWF0ZSBHaXRSZXBvc2l0b3J5IGNhbGxzIHRoZSBGbHV4R2l0UmVwb3NpdG9yeSgpLmdlbmVyYXRlIHRvIGNyZWF0ZSBHaXRSZXBvc3RvcnkgcmVzb3VyY2UuXHJcbiAqL1xyXG5mdW5jdGlvbiBjcmVhdGVHaXRSZXBvc2l0b3J5KGNsdXN0ZXJJbmZvOiBDbHVzdGVySW5mbywgbmFtZTogc3RyaW5nLCBuYW1lc3BhY2U6IHN0cmluZywgZmx1eEdpdFJlcG86IEZsdXhHaXRSZXBvKTogS3ViZXJuZXRlc01hbmlmZXN0IHtcclxuICBpZiAoZmx1eEdpdFJlcG8ucmVwb3NpdG9yeSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJNaXNzaW5nIEdpdCByZXBvc2l0b3J5XCIpO1xyXG4gIH1cclxuICBcclxuICBjb25zdCBtYW5pZmVzdCA9IG5ldyBGbHV4R2l0UmVwb3NpdG9yeShmbHV4R2l0UmVwby5yZXBvc2l0b3J5KS5nZW5lcmF0ZShcclxuICAgICAgICBmbHV4R2l0UmVwby5uYW1lLFxyXG4gICAgICAgIGZsdXhHaXRSZXBvLm5hbWVzcGFjZSA/PyBuYW1lc3BhY2UsXHJcbiAgICAgICAgZmx1eEdpdFJlcG8uc3luY0ludGVydmFsISxcclxuICAgICAgICBmbHV4R2l0UmVwby5zZWNyZXRSZWZOYW1lISk7XHJcbiAgbGV0IG1hbmlmZXN0TmFtZTogc3RyaW5nIHwgdW5kZWZpbmVkID0gbmFtZSArICdnaXRyZXBvc2l0b3J5JyArIGZsdXhHaXRSZXBvLm5hbWU7XHJcbiAgY29uc3QgY29uc3RydWN0ID0gY2x1c3RlckluZm8uY2x1c3Rlci5hZGRNYW5pZmVzdChtYW5pZmVzdE5hbWUhLCBtYW5pZmVzdCk7XHJcbiAgcmV0dXJuIGNvbnN0cnVjdDtcclxufVxyXG5cclxuLyoqXHJcbiAqIGNyZWF0ZSBLdXN0b21pemF0aW9ucyBjYWxscyB0aGUgRmx1eEt1c3RvbWl6YXRpb24oKS5nZW5lcmF0ZSBtdWx0aXBsZSB0aW1lcyB0byBjcmVhdGUgS3VzdG9taXphdGlvbiByZXNvdXJjZXMuXHJcbiAqL1xyXG5mdW5jdGlvbiBjcmVhdGVLdXN0b21pemF0aW9ucyhjbHVzdGVySW5mbzogQ2x1c3RlckluZm8sIG5hbWU6IHN0cmluZywgbmFtZXNwYWNlOiBzdHJpbmcsIGZsdXhHaXRSZXBvOiBGbHV4R2l0UmVwbyk6IEt1YmVybmV0ZXNNYW5pZmVzdFtdIHtcclxuICBjb25zdCBjb25zdHJ1Y3RzOiBLdWJlcm5ldGVzTWFuaWZlc3RbXSA9IFtdO1xyXG4gIGNvbnN0IGt1c3RvbWl6YXRpb25zID0gZmx1eEdpdFJlcG8ua3VzdG9taXphdGlvbnMgPz8gW3trdXN0b21pemF0aW9uUGF0aDogXCIuXCJ9XTtcclxuICBjb25zdCBmbHV4S3VzdG9taXphdGlvbiA9IG5ldyBGbHV4S3VzdG9taXphdGlvbigpO1xyXG4gIGt1c3RvbWl6YXRpb25zPy5tYXAoKGt1c3RvbWl6YXRpb24sIGluZGV4KSA9PiB7XHJcbiAgICBrdXN0b21pemF0aW9uID0gey4uLmRlZmF1bHRLdXN0b21pYXRpb25Qcm9wcywgLi4ua3VzdG9taXphdGlvbn07XHJcbiAgICBjb25zdCBtYW5pZmVzdCA9Zmx1eEt1c3RvbWl6YXRpb24uZ2VuZXJhdGUoXHJcbiAgICAgIGZsdXhHaXRSZXBvLm5hbWUgKyBcIi1cIiArIGluZGV4LFxyXG4gICAgICBmbHV4R2l0UmVwby5uYW1lLFxyXG4gICAgICBmbHV4R2l0UmVwby5uYW1lc3BhY2UgPz8gbmFtZXNwYWNlLFxyXG4gICAgICBrdXN0b21pemF0aW9uLnN5bmNJbnRlcnZhbCEsXHJcbiAgICAgIGt1c3RvbWl6YXRpb24ucHJ1bmUhLFxyXG4gICAgICBrdXN0b21pemF0aW9uLnRpbWVvdXQhLFxyXG4gICAgICBmbHV4R2l0UmVwby52YWx1ZXMsXHJcbiAgICAgIGt1c3RvbWl6YXRpb24ua3VzdG9taXphdGlvblBhdGgsXHJcbiAgICAgIGt1c3RvbWl6YXRpb24ua3VzdG9taXphdGlvblRhcmdldE5hbWVzcGFjZSxcclxuICAgICk7XHJcbiAgICBsZXQgbWFuaWZlc3ROYW1lOiBzdHJpbmcgfCB1bmRlZmluZWQgPSBuYW1lICsgJ2t1c3RvbWl6YXRpb24nICtmbHV4R2l0UmVwby5uYW1lICsgaW5kZXg7XHJcbiAgICBjb25zdHJ1Y3RzLnB1c2goY2x1c3RlckluZm8uY2x1c3Rlci5hZGRNYW5pZmVzdChtYW5pZmVzdE5hbWUhLCBtYW5pZmVzdCkpO1xyXG4gICAgXHJcbiAgfSk7XHJcblxyXG4gIHJldHVybiBjb25zdHJ1Y3RzO1xyXG59XHJcbiJdfQ==