"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AmpAddOn = void 0;
const utils_1 = require("../../utils");
const adot_1 = require("../adot");
const kubectl_provider_1 = require("../helm-addon/kubectl-provider");
const aws_aps_1 = require("aws-cdk-lib/aws-aps");
/**
 * Defaults options for the add-on
 */
const defaultProps = {
    deploymentMode: "deployment" /* DeploymentMode.DEPLOYMENT */,
    name: 'adot-collector-amp',
    namespace: 'default',
    enableAPIserverJob: false
};
/**
 * Implementation of AMP add-on for EKS Blueprints. Installs ADOT Collector.
 */
let AmpAddOn = class AmpAddOn {
    constructor(props) {
        this.ampAddOnProps = { ...defaultProps, ...props };
    }
    deploy(clusterInfo) {
        var _a;
        const cluster = clusterInfo.cluster;
        let doc;
        // Applying manifest for configuring ADOT Collector for Amp.
        if (this.ampAddOnProps.deploymentMode == "daemonset" /* DeploymentMode.DAEMONSET */) {
            doc = (0, utils_1.readYamlDocument)(__dirname + '/collector-config-amp-daemonset.ytpl');
        }
        else {
            doc = (0, utils_1.readYamlDocument)(__dirname + '/collector-config-amp.ytpl');
        }
        doc = (0, utils_1.changeTextBetweenTokens)(doc, "{{ if enableAPIserverJob }}", "{{ end }}", this.ampAddOnProps.enableAPIServerJob);
        const manifest = doc.split("---").map(e => {
            var _a;
            let object = (0, utils_1.loadYaml)(e);
            if (((_a = this.ampAddOnProps.openTelemetryCollector) === null || _a === void 0 ? void 0 : _a.manifestPath) !== undefined && object.kind === "OpenTelemetryCollector") {
                object = (0, utils_1.readYamlDocument)(this.ampAddOnProps.openTelemetryCollector.manifestPath);
                object = (0, utils_1.loadYaml)(object);
            }
            return object;
        });
        const attrPrometheusEndpoint = this.ampAddOnProps.ampPrometheusEndpoint + 'api/v1/remote_write';
        const values = {
            remoteWriteEndpoint: attrPrometheusEndpoint,
            awsRegion: cluster.stack.region,
            deploymentMode: this.ampAddOnProps.deploymentMode,
            namespace: this.ampAddOnProps.namespace,
            clusterName: cluster.clusterName,
            ...(_a = this.ampAddOnProps.openTelemetryCollector) === null || _a === void 0 ? void 0 : _a.manifestParameterMap
        };
        const manifestDeployment = {
            name: this.ampAddOnProps.name,
            namespace: this.ampAddOnProps.namespace,
            manifest,
            values
        };
        const kubectlProvider = new kubectl_provider_1.KubectlProvider(clusterInfo);
        const statement = kubectlProvider.addManifest(manifestDeployment);
        const ampRules = this.ampAddOnProps.ampRules;
        if (ampRules !== undefined) {
            const ruleGroupsNamespaces = this.configureRules(cluster, ampRules.ruleFilePaths, ampRules.ampWorkspaceArn);
            statement.node.addDependency(ruleGroupsNamespaces.at(-1));
        }
        return Promise.resolve(statement);
    }
    configureRules(cluster, ruleFilePaths, ampWorkspaceArn) {
        const ruleGroupsNamespaces = [];
        if (ruleFilePaths.length == 0) {
            throw new Error("No paths defined for AMP rules");
        }
        ruleFilePaths.map((ruleFilePath, index) => {
            const ruleGroupsNamespace = new aws_aps_1.CfnRuleGroupsNamespace(cluster, "AmpRulesConfigurator-" + index, {
                data: (0, utils_1.readYamlDocument)(ruleFilePath),
                name: "AmpRulesConfigurator-" + index,
                workspace: ampWorkspaceArn
            });
            if (index > 0) {
                ruleGroupsNamespace.node.addDependency(ruleGroupsNamespaces.at(-1));
            }
            ruleGroupsNamespaces.push(ruleGroupsNamespace);
        });
        return ruleGroupsNamespaces;
    }
};
exports.AmpAddOn = AmpAddOn;
__decorate([
    (0, utils_1.dependable)(adot_1.AdotCollectorAddOn.name)
], AmpAddOn.prototype, "deploy", null);
exports.AmpAddOn = AmpAddOn = __decorate([
    utils_1.supportsALL
], AmpAddOn);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvYWRkb25zL2FtcC9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFDQSx1Q0FBMkc7QUFDM0csa0NBQTZDO0FBRTdDLHFFQUFxRjtBQUNyRixpREFBNkQ7QUFzRjdEOztHQUVHO0FBQ0gsTUFBTSxZQUFZLEdBQUc7SUFDakIsY0FBYyw4Q0FBMkI7SUFDekMsSUFBSSxFQUFFLG9CQUFvQjtJQUMxQixTQUFTLEVBQUUsU0FBUztJQUNwQixrQkFBa0IsRUFBRSxLQUFLO0NBQzVCLENBQUM7QUFFRjs7R0FFRztBQUVJLElBQU0sUUFBUSxHQUFkLE1BQU0sUUFBUTtJQUlqQixZQUFZLEtBQW9CO1FBQzVCLElBQUksQ0FBQyxhQUFhLEdBQUcsRUFBRSxHQUFHLFlBQVksRUFBRSxHQUFHLEtBQUssRUFBRSxDQUFDO0lBQ3ZELENBQUM7SUFHRCxNQUFNLENBQUMsV0FBd0I7O1FBQzNCLE1BQU0sT0FBTyxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUM7UUFDcEMsSUFBSSxHQUFXLENBQUM7UUFFaEIsNERBQTREO1FBQzVELElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxjQUFjLDhDQUE0QixFQUFFLENBQUM7WUFDaEUsR0FBRyxHQUFHLElBQUEsd0JBQWdCLEVBQUMsU0FBUyxHQUFFLHNDQUFzQyxDQUFDLENBQUM7UUFDOUUsQ0FBQzthQUNJLENBQUM7WUFDRixHQUFHLEdBQUcsSUFBQSx3QkFBZ0IsRUFBQyxTQUFTLEdBQUcsNEJBQTRCLENBQUMsQ0FBQztRQUNyRSxDQUFDO1FBRUQsR0FBRyxHQUFHLElBQUEsK0JBQXVCLEVBQ3pCLEdBQUcsRUFDSCw2QkFBNkIsRUFDN0IsV0FBVyxFQUNYLElBQUksQ0FBQyxhQUFhLENBQUMsa0JBQW1CLENBQ3JDLENBQUM7UUFFTixNQUFNLFFBQVEsR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFD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QUFDLENBQUMsQ0FBRSxDQUFDLENBQUM7WUFDekUsQ0FBQztZQUNELG9CQUFvQixDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1FBQ25ELENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxvQkFBb0IsQ0FBQztJQUNoQyxDQUFDO0NBQ0osQ0FBQTtBQXRGWSw0QkFBUTtBQVNqQjtJQURDLElBQUEsa0JBQVUsRUFBQyx5QkFBa0IsQ0FBQyxJQUFJLENBQUM7c0NBdURuQzttQkEvRFEsUUFBUTtJQURwQixtQkFBVztHQUNDLFFBQVEsQ0FzRnBCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2x1c3RlckFkZE9uLCBDbHVzdGVySW5mbywgVmFsdWVzIH0gZnJvbSBcIi4uLy4uL3NwaVwiO1xuaW1wb3J0IHsgZGVwZW5kYWJsZSwgbG9hZFlhbWwsIHJlYWRZYW1sRG9jdW1lbnQsIGNoYW5nZVRleHRCZXR3ZWVuVG9rZW5zLCBzdXBwb3J0c0FMTCB9IGZyb20gXCIuLi8uLi91dGlsc1wiO1xuaW1wb3J0IHsgQWRvdENvbGxlY3RvckFkZE9uIH0gZnJvbSBcIi4uL2Fkb3RcIjtcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHsgS3ViZWN0bFByb3ZpZGVyLCBNYW5pZmVzdERlcGxveW1lbnQgfSBmcm9tIFwiLi4vaGVsbS1hZGRvbi9rdWJlY3RsLXByb3ZpZGVyXCI7XG5pbXBvcnQgeyBDZm5SdWxlR3JvdXBzTmFtZXNwYWNlIH0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1hcHNcIjtcbmltcG9ydCB7IElDbHVzdGVyIH0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1la3NcIjtcblxuLyoqXG4gKiBUaGlzIEFNUCBhZGQtb24gaW5zdGFsbHMgYW4gQURPVCBDb2xsZWN0b3IgZm9yIEFtYXpvbiBNYW5hZ2VkIFNlcnZpY2UgZm9yIFByb21ldGhldXMgXG4gKiAoQU1QKSBhbmQgY3JlYXRlcyBhbiBBTVAgd29ycHNhY2UgdG8gcmVjZWl2ZSBPVExQIG1ldHJpY3MgZnJvbSB0aGUgYXBwbGljYXRpb24gYW5kIFxuICogUHJvbWV0aGV1cyBtZXRyaWNzIHNjcmFwZWQgZnJvbSBwb2RzIG9uIHRoZSBjbHVzdGVyIGFuZCByZW1vdGUgd3JpdGVzIHRoZSBtZXRyaWNzIFxuICogdG8gQU1QIHJlbW90ZSB3cml0ZSBlbmRwb2ludCBvZiB0aGUgY3JlYXRlZCBvciBwYXNzZWQgQU1QIHdvcmtzcGFjZS5cbiAqL1xuXG5leHBvcnQgaW50ZXJmYWNlIEFtcFJ1bGVzIHtcbiAgICAvKiogXG4gICAgICogQU1QIHdvcmtzcGFjZSBBUk4uXG4gICAgICovXG4gICAgYW1wV29ya3NwYWNlQXJuOiBzdHJpbmc7XG5cbiAgICAvKiogXG4gICAgICogUGF0aHMgb2YgdGhlIGZpbGVzIGxpc3RpbmcgdGhlIEFNUCBydWxlcy5cbiAgICAgKi9cbiAgICBydWxlRmlsZVBhdGhzOiBzdHJpbmdbXTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBPcGVuVGVsZW1ldHJ5Q29sbGVjdG9yIHtcbiAgICAgLyoqXG4gICAgICogQW4gYWx0ZXJuYXRpdmUgT3BlblRlbGVtZXRyeUNvbGxlY3RvciBpZiB5b3UgbmVlZCBmdXJ0aGVyIGN1c29taXNhdGlvbi5cbiAgICAgKiBJZiBub3QgcHJvdmlkZWQsIHRoZSBkZWZhdWx0IHdpbGwgYmUgdXNlZC5cbiAgICAgKi9cbiAgICAgbWFuaWZlc3RQYXRoOiBzdHJpbmc7XG4gICAgIC8qKlxuICAgICAqIFRoaXMgcGFyYW1ldGVyIGlzIG9wdGlvbmFsIGFuZCBob2xkcyBhbiBvYmplY3Qgb2YgdHlwZSBWYWx1ZXMsIHdpdGgga2V5cyBhbmQgdmFsdWVzLlxuICAgICAqIFRoZSBzYW1lIGtleSBsaXRlcmFscyB3aWxsIG5lZWQgdG8gYmUgdXNlZCB3aXRoaW4gdGhlIG1hbmlmZXN0IGJldHdlZW4gZG91YmxlIGN1cmx5IGJyYWNlcyB7e319IGFuZCB0aGUgYWRkLW9uIHdpbGwgcmVwbGFjZSB0aGVtIHdpdGggdGhlIHJlbGF0ZWQgdmFsdWVzLlxuICAgICAqIFRoZSBmb2xsb3dpbmcga2V5cyBhcmUgYWxyZWFkeSBpbiB1c2UgYnkgdGhlIGFkZC1vbiBhbmQgd2lsbCBiZSByZXBsYWNlZCBpbiB5b3VyIG1hbmlmZXN0IHdpdGggY29uZmlndXJlZCB2YWx1ZXMsIGlmIHlvdSB3YW50IHRvIHVzZSB0aGVtOlxuICAgICAqIHJlbW90ZVdyaXRlRW5kcG9pbnQsIGF3c1JlZ2lvbiwgZGVwbG95bWVudE1vZGUsIG5hbWVzcGFjZSwgY2x1c3Rlck5hbWUuIFRvIHVzZSBhbnkgb2YgdGhvc2UgeW91IGNhbiBqdXN0IGluY2x1ZGUgZS5nLiB7e3JlbW90ZVdyaXRlRW5kcG9pbnR9fSBpbnNpZGUgdGhlIG1hbmlmZXN0LlxuICAgICAqL1xuICAgICBtYW5pZmVzdFBhcmFtZXRlck1hcD86IFZhbHVlcztcbn1cblxuLyoqXG4gKiBDb25maWd1cmF0aW9uIG9wdGlvbnMgZm9yIGFkZC1vbi5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBBbXBBZGRPblByb3BzIHtcbiAgICAvKiogXG4gICAgICogUmVtb3RlIFdyaXRlIFVSTCBvZiB0aGUgQU1QIFdvcmtzcGFjZSB0byBiZSB1c2VkIGZvciBzZXR0aW5nIHVwIHJlbW90ZSB3cml0ZS5cbiAgICAgKiAgRm9ybWF0IDogaHR0cHM6Ly9hcHMtd29ya3NwYWNlcy48cmVnaW9uPi5hbWF6b25hd3MuY29tL3dvcmtzcGFjZXMvPHdzLXdvcmtzcGFjZWlkPi9cIixcbiAgICAgKi9cbiAgICBhbXBQcm9tZXRoZXVzRW5kcG9pbnQ6IHN0cmluZztcbiAgICAvKipcbiAgICAgKiBNb2RlcyBzdXBwb3J0ZWQgOiBgZGVwbG95bWVudGAsIGBkYWVtb25zZXRgLCBgc3RhdGVmdWxTZXRgLCBhbmQgYHNpZGVjYXJgXG4gICAgICogQGRlZmF1bHQgZGVwbG95bWVudFxuICAgICAqL1xuICAgIGRlcGxveW1lbnRNb2RlPzogRGVwbG95bWVudE1vZGU7XG4gICAgLyoqXG4gICAgICogTmFtZXNwYWNlIHRvIGRlcGxveSB0aGUgQURPVCBDb2xsZWN0b3IgZm9yIEFNUC5cbiAgICAgKiBAZGVmYXVsdCBkZWZhdWx0XG4gICAgICovXG4gICAgbmFtZXNwYWNlPzogc3RyaW5nO1xuICAgIC8qKlxuICAgICAqIE5hbWUgZm9yIGRlcGxveW1lbnQgb2YgdGhlIEFET1QgQ29sbGVjdG9yIGZvciBBTVAuXG4gICAgICogQGRlZmF1bHQgJ2Fkb3QtY29sbGVjdG9yLWFtcCdcbiAgICAgKi9cbiAgICBuYW1lPzogc3RyaW5nO1xuICAgIC8qKlxuICAgICAqIEVuYWJsZSBcImFwaXNlcnZlclwiIGpvYiBpbiB0aGUgUHJvbWV0aGV1cyBjb25maWd1cmF0aW9uIG9mIHRoZSBkZWZhdWx0IE9wZW5UZWxlbWV0cnlDb2xsZWN0b3IuXG4gICAgICogQGRlZmF1bHQgZmFsc2VcbiAgICAgKi9cbiAgICBlbmFibGVBUElTZXJ2ZXJKb2I/OiBib29sZWFuO1xuICAgIC8qKiBcbiAgICAgKiBBTVAgcnVsZXMgcHJvdmlkaW5nIEFNUCB3b3Jrc3BhY2UgQVJOIGFuZCBwYXRocyB0byBmaWxlcyBlbmNvZGluZyByZWNvcmRpbmcgYW5kL29yIGFsZXJ0aW5nIHJ1bGVzIGZvbGxvd2luZyB0aGUgc2FtZSBmb3JtYXQgYXMgYSBydWxlcyBmaWxlIGluIHN0YW5kYWxvbmUgUHJvbWV0aGV1cy5cbiAgICAgKiBUaGlzIHBhcmFtZXRlciBpcyBvcHRpb25hbCBhbmQgaWYgbm90IHByb3ZpZGVkLCBubyBydWxlcyB3aWxsIGJlIGFwcGxpZWQuXG4gICAgICovXG4gICAgYW1wUnVsZXM/OiBBbXBSdWxlcztcbiAgICAgLyoqXG4gICAgICogQW4gYWx0ZXJuYXRpdmUgT3BlblRlbGVtZXRyeUNvbGxlY3RvciBpZiB5b3UgbmVlZCBmdXJ0aGVyIGN1c3RvbWlzYXRpb24uXG4gICAgICogSWYgeW91IG5lZWQgdG8gY29uZmlndXJlIHJ1bGVzLCBwbGVhc2UgZG8gbm90IHVzZSB0aGUgcnVsZV9maWxlcyBmaWVsZCBsaWtlIGluIHN0YW5kYWxvbmUgUHJvbWV0aGV1cywgYnV0IHJhdGhlciB1c2UgdGhlIGFtcFJ1bGVzIHBhcmFtZXRlci5cbiAgICAgKiBJZiBub3QgcHJvdmlkZWQsIHRoZSBkZWZhdWx0IHdpbGwgYmUgdXNlZC5cbiAgICAgKi9cbiAgICBvcGVuVGVsZW1ldHJ5Q29sbGVjdG9yPzogT3BlblRlbGVtZXRyeUNvbGxlY3Rvcjtcbn1cblxuZXhwb3J0IGNvbnN0IGVudW0gRGVwbG95bWVudE1vZGUge1xuICAgIERFUExPWU1FTlQgPSAnZGVwbG95bWVudCcsXG4gICAgREFFTU9OU0VUID0gJ2RhZW1vbnNldCcsXG4gICAgU1RBVEVGVUxTRVQgPSAnc3RhdGVmdWxzZXQnLFxuICAgIFNJREVDQVIgPSAnc2lkZWNhcidcbn1cblxuLyoqXG4gKiBEZWZhdWx0cyBvcHRpb25zIGZvciB0aGUgYWRkLW9uXG4gKi9cbmNvbnN0IGRlZmF1bHRQcm9wcyA9IHtcbiAgICBkZXBsb3ltZW50TW9kZTogRGVwbG95bWVudE1vZGUuREVQTE9ZTUVOVCxcbiAgICBuYW1lOiAnYWRvdC1jb2xsZWN0b3ItYW1wJyxcbiAgICBuYW1lc3BhY2U6ICdkZWZhdWx0JyxcbiAgICBlbmFibGVBUElzZXJ2ZXJKb2I6IGZhbHNlXG59O1xuXG4vKipcbiAqIEltcGxlbWVudGF0aW9uIG9mIEFNUCBhZGQtb24gZm9yIEVLUyBCbHVlcHJpbnRzLiBJbnN0YWxscyBBRE9UIENvbGxlY3Rvci5cbiAqL1xuQHN1cHBvcnRzQUxMXG5leHBvcnQgY2xhc3MgQW1wQWRkT24gaW1wbGVtZW50cyBDbHVzdGVyQWRkT24ge1xuXG4gICAgcmVhZG9ubHkgYW1wQWRkT25Qcm9wczogQW1wQWRkT25Qcm9wcztcblxuICAgIGNvbnN0cnVjdG9yKHByb3BzOiBBbXBBZGRPblByb3BzKSB7XG4gICAgICAgIHRoaXMuYW1wQWRkT25Qcm9wcyA9IHsgLi4uZGVmYXVsdFByb3BzLCAuLi5wcm9wcyB9O1xuICAgIH1cblxuICAgIEBkZXBlbmRhYmxlKEFkb3RDb2xsZWN0b3JBZGRPbi5uYW1lKVxuICAgIGRlcGxveShjbHVzdGVySW5mbzogQ2x1c3RlckluZm8pOiBQcm9taXNlPENvbnN0cnVjdD4ge1xuICAgICAgICBjb25zdCBjbHVzdGVyID0gY2x1c3RlckluZm8uY2x1c3RlcjtcbiAgICAgICAgbGV0IGRvYzogc3RyaW5nO1xuXG4gICAgICAgIC8vIEFwcGx5aW5nIG1hbmlmZXN0IGZvciBjb25maWd1cmluZyBBRE9UIENvbGxlY3RvciBmb3IgQW1wLlxuICAgICAgICBpZiAodGhpcy5hbXBBZGRPblByb3BzLmRlcGxveW1lbnRNb2RlID09IERlcGxveW1lbnRNb2RlLkRBRU1PTlNFVCkge1xuICAgICAgICAgICAgZG9jID0gcmVhZFlhbWxEb2N1bWVudChfX2Rpcm5hbWUgKycvY29sbGVjdG9yLWNvbmZpZy1hbXAtZGFlbW9uc2V0Lnl0cGwnKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGRvYyA9IHJlYWRZYW1sRG9jdW1lbnQoX19kaXJuYW1lICsgJy9jb2xsZWN0b3ItY29uZmlnLWFtcC55dHBsJyk7XG4gICAgICAgIH1cblxuICAgICAgICBkb2MgPSBjaGFuZ2VUZXh0QmV0d2VlblRva2VucyhcbiAgICAgICAgICAgIGRvYyxcbiAgICAgICAgICAgIFwie3sgaWYgZW5hYmxlQVBJc2VydmVySm9iIH19XCIsXG4gICAgICAgICAgICBcInt7IGVuZCB9fVwiLFxuICAgICAgICAgICAgdGhpcy5hbXBBZGRPblByb3BzLmVuYWJsZUFQSVNlcnZlckpvYiFcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgY29uc3QgbWFuaWZlc3QgPSBkb2Muc3BsaXQoXCItLS1cIikubWFwKGUgPT4ge1xuICAgICAgICAgICAgbGV0IG9iamVjdCA9IGxvYWRZYW1sKGUpO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5hbXBBZGRPblByb3BzLm9wZW5UZWxlbWV0cnlDb2xsZWN0b3I/Lm1hbmlmZXN0UGF0aCAhPT0gdW5kZWZpbmVkICYmIG9iamVjdC5raW5kID09PSBcIk9wZW5UZWxlbWV0cnlDb2xsZWN0b3JcIil7XG4gICAgICAgICAgICAgICAgb2JqZWN0ID0gcmVhZFlhbWxEb2N1bWVudCh0aGlzLmFtcEFkZE9uUHJvcHMub3BlblRlbGVtZXRyeUNvbGxlY3Rvci5tYW5pZmVzdFBhdGghKTtcbiAgICAgICAgICAgICAgICBvYmplY3QgPSBsb2FkWWFtbChvYmplY3QpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIG9iamVjdDtcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IGF0dHJQcm9tZXRoZXVzRW5kcG9pbnQgPSB0aGlzLmFtcEFkZE9uUHJvcHMuYW1wUHJvbWV0aGV1c0VuZHBvaW50ICsgJ2FwaS92MS9yZW1vdGVfd3JpdGUnO1xuICAgICAgICBjb25zdCB2YWx1ZXM6IFZhbHVlcyA9IHtcbiAgICAgICAgICAgIHJlbW90ZVdyaXRlRW5kcG9pbnQ6IGF0dHJQcm9tZXRoZXVzRW5kcG9pbnQsXG4gICAgICAgICAgICBhd3NSZWdpb246IGNsdXN0ZXIuc3RhY2sucmVnaW9uLFxuICAgICAgICAgICAgZGVwbG95bWVudE1vZGU6IHRoaXMuYW1wQWRkT25Qcm9wcy5kZXBsb3ltZW50TW9kZSxcbiAgICAgICAgICAgIG5hbWVzcGFjZTogdGhpcy5hbXBBZGRPblByb3BzLm5hbWVzcGFjZSxcbiAgICAgICAgICAgIGNsdXN0ZXJOYW1lOiBjbHVzdGVyLmNsdXN0ZXJOYW1lLFxuICAgICAgICAgICAgLi4udGhpcy5hbXBBZGRPblByb3BzLm9wZW5UZWxlbWV0cnlDb2xsZWN0b3I/Lm1hbmlmZXN0UGFyYW1ldGVyTWFwXG4gICAgICAgICB9O1xuICAgICAgICAgXG4gICAgICAgICBjb25zdCBtYW5pZmVzdERlcGxveW1lbnQ6IE1hbmlmZXN0RGVwbG95bWVudCA9IHtcbiAgICAgICAgICAgIG5hbWU6IHRoaXMuYW1wQWRkT25Qcm9wcy5uYW1lISxcbiAgICAgICAgICAgIG5hbWVzcGFjZTogdGhpcy5hbXBBZGRPblByb3BzLm5hbWVzcGFjZSEsXG4gICAgICAgICAgICBtYW5pZmVzdCxcbiAgICAgICAgICAgIHZhbHVlc1xuICAgICAgICB9O1xuICAgICAgICBjb25zdCBrdWJlY3RsUHJvdmlkZXIgPSBuZXcgS3ViZWN0bFByb3ZpZGVyKGNsdXN0ZXJJbmZvKTtcbiAgICAgICAgY29uc3Qgc3RhdGVtZW50ID0ga3ViZWN0bFByb3ZpZGVyLmFkZE1hbmlmZXN0KG1hbmlmZXN0RGVwbG95bWVudCk7XG5cbiAgICAgICAgY29uc3QgYW1wUnVsZXMgPSB0aGlzLmFtcEFkZE9uUHJvcHMuYW1wUnVsZXM7XG4gICAgICAgIGlmIChhbXBSdWxlcyAhPT0gdW5kZWZpbmVkKXtcbiAgICAgICAgICAgIGNvbnN0IHJ1bGVHcm91cHNOYW1lc3BhY2VzID0gdGhpcy5jb25maWd1cmVSdWxlcyhjbHVzdGVyLCBhbXBSdWxlcy5ydWxlRmlsZVBhdGhzLCBhbXBSdWxlcy5hbXBXb3Jrc3BhY2VBcm4pO1xuICAgICAgICAgICAgc3RhdGVtZW50Lm5vZGUuYWRkRGVwZW5kZW5jeShydWxlR3JvdXBzTmFtZXNwYWNlcy5hdCgtMSkhKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoc3RhdGVtZW50KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNvbmZpZ3VyZVJ1bGVzKGNsdXN0ZXI6IElDbHVzdGVyLCBydWxlRmlsZVBhdGhzOiBzdHJpbmdbXSwgYW1wV29ya3NwYWNlQXJuOiBzdHJpbmcpOiBDZm5SdWxlR3JvdXBzTmFtZXNwYWNlW10ge1xuICAgICAgICBjb25zdCBydWxlR3JvdXBzTmFtZXNwYWNlczogQ2ZuUnVsZUdyb3Vwc05hbWVzcGFjZVtdID0gW107XG5cbiAgICAgICAgaWYgKHJ1bGVGaWxlUGF0aHMubGVuZ3RoID09IDApIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIk5vIHBhdGhzIGRlZmluZWQgZm9yIEFNUCBydWxlc1wiKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJ1bGVGaWxlUGF0aHMubWFwKChydWxlRmlsZVBhdGgsIGluZGV4KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBydWxlR3JvdXBzTmFtZXNwYWNlID0gbmV3IENmblJ1bGVHcm91cHNOYW1lc3BhY2UoY2x1c3RlciwgXCJBbXBSdWxlc0NvbmZpZ3VyYXRvci1cIiArIGluZGV4LCB7XG4gICAgICAgICAgICAgICAgZGF0YTogcmVhZFlhbWxEb2N1bWVudChydWxlRmlsZVBhdGgpLFxuICAgICAgICAgICAgICAgIG5hbWU6IFwiQW1wUnVsZXNDb25maWd1cmF0b3ItXCIgKyBpbmRleCxcbiAgICAgICAgICAgICAgICB3b3Jrc3BhY2U6IGFtcFdvcmtzcGFjZUFyblxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBpZiAoaW5kZXggPiAwKXtcbiAgICAgICAgICAgICAgICBydWxlR3JvdXBzTmFtZXNwYWNlLm5vZGUuYWRkRGVwZW5kZW5jeShydWxlR3JvdXBzTmFtZXNwYWNlcy5hdCgtMSkhKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJ1bGVHcm91cHNOYW1lc3BhY2VzLnB1c2gocnVsZUdyb3Vwc05hbWVzcGFjZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBydWxlR3JvdXBzTmFtZXNwYWNlcztcbiAgICB9XG59XG4iXX0=