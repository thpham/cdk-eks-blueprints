"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.IngressNginxAddOn = void 0;
const ts_deepmerge_1 = require("ts-deepmerge");
const dot = require("dot-object");
const utils_1 = require("../../utils");
const object_utils_1 = require("../../utils/object-utils");
const helm_addon_1 = require("../helm-addon");
const __1 = require("..");
// Set default properties for the add-on
const defaultProps = {
    name: "kubernetes-ingress",
    chart: "ingress-nginx",
    release: "k8s-ingress",
    version: "4.10.1",
    repository: "https://kubernetes.github.io/ingress-nginx",
    backendProtocol: 'http',
    crossZoneEnabled: true,
    internetFacing: true,
    targetType: 'ip',
    namespace: 'kube-system',
    sslPort: 'https',
    httpTargetPort: 'http',
    httpsTargetPort: 'https',
    forceSSLRedirect: true,
    loadBalancerType: 'external',
    serviceType: "LoadBalancer",
    idleTimeout: '3600'
};
// Define the class for the Kubernetes Ingress Add-On, extending HelmAddOn
let IngressNginxAddOn = class IngressNginxAddOn extends helm_addon_1.HelmAddOn {
    // Constructor for the class, merging default props with user-defined props
    constructor(props) {
        super({ ...defaultProps, ...props });
        this.options = { ...defaultProps, ...props };
    }
    // Dependency decorator to ensure this add-on is deployed after the AWS Load Balancer Controller
    async deploy(clusterInfo) {
        var _a, _b;
        const props = this.options;
        // Setup service annotations based on the properties provided
        const loadBalancerAnnotations = {
            'service.beta.kubernetes.io/aws-load-balancer-backend-protocol': props.backendProtocol,
            'service.beta.kubernetes.io/aws-load-balancer-attributes': `load_balancing.cross_zone.enabled=${props.crossZoneEnabled}`,
            'service.beta.kubernetes.io/aws-load-balancer-scheme': props.internetFacing ? 'internet-facing' : 'internal',
            'service.beta.kubernetes.io/aws-load-balancer-type': props.loadBalancerType,
            'service.beta.kubernetes.io/aws-load-balancer-nlb-target-type': props.targetType,
            'external-dns.alpha.kubernetes.io/hostname': props.externalDnsHostname,
            'service.beta.kubernetes.io/aws-load-balancer-connection-idle-timeout': '3600'
        };
        // Define values for Helm chart based on properties and annotations
        const values = {
            controller: {
                service: {
                    annotations: props.serviceType == 'LoadBalancer' ? loadBalancerAnnotations : {}
                },
                ingressClassResource: {
                    name: props.ingressClassName || "ingress-nginx",
                    enabled: true,
                    default: (_a = props.isDefaultClass) !== null && _a !== void 0 ? _a : false,
                    controllerValue: props.controllerClass || "k8s.io/ingress-nginx"
                },
                electionID: props.electionId || "ingress-controller-leader"
            }
        };
        // Combine logic for handling certificate annotations
        let certificateResourceARN = props.certificateResourceARN;
        if (!certificateResourceARN && props.certificateResourceName) {
            const certificate = clusterInfo.getResource(props.certificateResourceName);
            certificateResourceARN = certificate === null || certificate === void 0 ? void 0 : certificate.certificateArn;
        }
        if (certificateResourceARN) {
            loadBalancerAnnotations['service.beta.kubernetes.io/aws-load-balancer-ssl-ports'] = props.sslPort;
            loadBalancerAnnotations['service.beta.kubernetes.io/aws-load-balancer-ssl-cert'] = certificateResourceARN;
            if (props.forceSSLRedirect) {
                loadBalancerAnnotations['nginx.ingress.kubernetes.io/force-ssl-redirect'] = true;
            }
        }
        // Set HTTP and HTTPS target ports
        (0, object_utils_1.setPath)(values, "controller.service.targetPorts.http", props.httpTargetPort);
        const httpsTargetPort = dot.pick("controller.service.targetPorts.https", props.values) || props.httpsTargetPort;
        (0, object_utils_1.setPath)(values, "controller.service.targetPorts.https", httpsTargetPort);
        // Merge user-defined values with defaults for the Helm chart deployment
        const mergedValues = (0, ts_deepmerge_1.merge)(values, (_b = this.props.values) !== null && _b !== void 0 ? _b : {});
        const nginxHelmChart = this.addHelmChart(clusterInfo, mergedValues);
        return Promise.resolve(nginxHelmChart);
    }
};
exports.IngressNginxAddOn = IngressNginxAddOn;
__decorate([
    (0, utils_1.dependable)(__1.AwsLoadBalancerControllerAddOn.name)
], IngressNginxAddOn.prototype, "deploy", null);
exports.IngressNginxAddOn = IngressNginxAddOn = __decorate([
    utils_1.supportsALL
], IngressNginxAddOn);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvYWRkb25zL2luZ3Jlc3MtbmdpbngvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBR0EsK0NBQXFDO0FBQ3JDLGtDQUFrQztBQUNsQyx1Q0FBc0Q7QUFDdEQsMkRBQW1EO0FBRW5ELDhDQUE4RTtBQUM5RSwwQkFBb0Q7QUF1SnBELHdDQUF3QztBQUN4QyxNQUFNLFlBQVksR0FBMkI7SUFDekMsSUFBSSxFQUFFLG9CQUFvQjtJQUMxQixLQUFLLEVBQUUsZUFBZTtJQUN0QixPQUFPLEVBQUUsYUFBYTtJQUN0QixPQUFPLEVBQUUsUUFBUTtJQUNqQixVQUFVLEVBQUUsNENBQTRDO0lBQ3hELGVBQWUsRUFBRSxNQUFNO0lBQ3ZCLGdCQUFnQixFQUFFLElBQUk7SUFDdEIsY0FBYyxFQUFFLElBQUk7SUFDcEIsVUFBVSxFQUFFLElBQUk7SUFDaEIsU0FBUyxFQUFFLGFBQWE7SUFDeEIsT0FBTyxFQUFFLE9BQU87SUFDaEIsY0FBYyxFQUFFLE1BQU07SUFDdEIsZUFBZSxFQUFFLE9BQU87SUFDeEIsZ0JBQWdCLEVBQUUsSUFBSTtJQUN0QixnQkFBZ0IsRUFBRSxVQUFVO0lBQzVCLFdBQVcsRUFBRSxjQUFjO0lBQzNCLFdBQVcsRUFBRSxNQUFNO0NBQ3RCLENBQUM7QUFFRiwwRUFBMEU7QUFFbkUsSUFBTSxpQkFBaUIsR0FBdkIsTUFBTSxpQkFBa0IsU0FBUSxzQkFBUztJQUc1QywyRUFBMkU7SUFDM0UsWUFBWSxLQUE4QjtRQUN0QyxLQUFLLENBQUMsRUFBRSxHQUFHLFlBQVksRUFBRSxHQUFHLEtBQUssRUFBb0IsQ0FBQyxDQUFDO1FBQ3ZELElBQUksQ0FBQyxPQUFPLEdBQUcsRUFBRSxHQUFHLFlBQVksRUFBRSxHQUFHLEtBQUssRUFBNEIsQ0FBQztJQUMzRSxDQUFDO0lBRUQsZ0dBQWdHO0lBRTFGLEFBQU4sS0FBSyxDQUFDLE1BQU0sQ0FBQyxXQUF3Qjs7UUFDakMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQztRQUUzQiw2REFBNkQ7UUFDN0QsTUFBTSx1QkFBdUIsR0FBUTtZQUNqQywrREFBK0QsRUFBRSxLQUFLLENBQUMsZUFBZTtZQUN0Rix5REFBeUQsRUFBRSxxQ0FBcUMsS0FBSyxDQUFDLGdCQUFnQixFQUFFO1lBQ3hILHFEQUFxRCxFQUFFLEtBQUssQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQyxVQUFVO1lBQzVHLG1EQUFtRCxFQUFFLEtBQUssQ0FBQyxnQkFBZ0I7WUFDM0UsOERBQThELEVBQUUsS0FBSyxDQUFDLFVBQVU7WUFDaEYsMkNBQTJDLEVBQUUsS0FBSyxDQUFDLG1CQUFtQjtZQUN0RSxzRUFBc0UsRUFBRSxNQUFNO1NBQ2pGLENBQUM7UUFFRixtRUFBbUU7UUFDbkUsTUFBTSxNQUFNLEdBQVc7WUFDbkIsVUFBVSxFQUFFO2dCQUNSLE9BQU8sRUFBRTtvQkFDTCxXQUFXLEVBQUUsS0FBSyxDQUFDLFdBQVcsSUFBSSxjQUFjLENBQUMsQ0FBQyxDQUFDLHVCQUF1QixDQUFDLENBQUMsQ0FBQyxFQUFFO2lCQUNsRjtnQkFDRCxvQkFBb0IsRUFBRTtvQkFDbEIsSUFBSSxFQUFFLEtBQUssQ0FBQyxnQkFBZ0IsSUFBSSxlQUFlO29CQUMvQyxPQUFPLEVBQUUsSUFBSTtvQkFDYixPQUFPLEVBQUUsTUFBQSxLQUFLLENBQUMsY0FBYyxtQ0FBSSxLQUFLO29CQUN0QyxlQUFlLEVBQUUsS0FBSyxDQUFDLGVBQWUsSUFBSSxzQkFBc0I7aUJBQ25FO2dCQUNELFVBQVUsRUFBRSxLQUFLLENBQUMsVUFBVSxJQUFJLDJCQUEyQjthQUM5RDtTQUNKLENBQUM7UUFFRixxREFBcUQ7UUFDckQsSUFBSSxzQkFBc0IsR0FBRyxLQUFLLENBQUMsc0JBQXNCLENBQUM7UUFFMUQsSUFBSSxDQUFDLHNCQUFzQixJQUFJLEtBQUssQ0FBQyx1QkFBdUIsRUFBRSxDQUFDO1lBQzNELE1BQU0sV0FBVyxHQUFHLFdBQVcsQ0FBQyxXQUFXLENBQWUsS0FBSyxDQUFDLHVCQUF1QixDQUFDLENBQUM7WUFDekYsc0JBQXNCLEdBQUcsV0FBVyxhQUFYLFdBQVcsdUJBQVgsV0FBVyxDQUFFLGNBQWMsQ0FBQztRQUN6RCxDQUFDO1FBRUQsSUFBSSxzQkFBc0IsRUFBRSxDQUFDO1lBQ3pCLHVCQUF1QixDQUFDLHdEQUF3RCxDQUFDLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQztZQUNsRyx1QkFBdUIsQ0FBQyx1REFBdUQsQ0FBQyxHQUFHLHNCQUFzQixDQUFDO1lBQzFHLElBQUksS0FBSyxDQUFDLGdCQUFnQixFQUFFLENBQUM7Z0JBQ3pCLHVCQUF1QixDQUFDLGdEQUFnRCxDQUFDLEdBQUcsSUFBSSxDQUFDO1lBQ3JGLENBQUM7UUFDTCxDQUFDO1FBRUQsa0NBQWtDO1FBQ2xDLElBQUEsc0JBQU8sRUFBQyxNQUFNLEVBQUUscUNBQXFDLEVBQUUsS0FBSyxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQzdFLE1BQU0sZUFBZSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsc0NBQXNDLEVBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEtBQUssQ0FBQyxlQUFlLENBQUM7UUFDaEgsSUFBQSxzQkFBTyxFQUFDLE1BQU0sRUFBRSxzQ0FBc0MsRUFBRSxlQUFlLENBQUMsQ0FBQztRQUV6RSx3RUFBd0U7UUFDeEUsTUFBTSxZQUFZLEdBQUcsSUFBQSxvQkFBSyxFQUFDLE1BQU0sRUFBRSxNQUFBLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxtQ0FBSSxFQUFFLENBQUMsQ0FBQztRQUM1RCxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxZQUFZLENBQUMsQ0FBQztRQUVwRSxPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDM0MsQ0FBQztDQUNKLENBQUE7QUFwRVksOENBQWlCO0FBV3BCO0lBREwsSUFBQSxrQkFBVSxFQUFDLGtDQUE4QixDQUFDLElBQUksQ0FBQzsrQ0F5RC9DOzRCQW5FUSxpQkFBaUI7SUFEN0IsbUJBQVc7R0FDQyxpQkFBaUIsQ0FvRTdCIiwic291cmNlc0NvbnRlbnQiOlsiLy8gSW1wb3J0IG5lY2Vzc2FyeSBBV1MgQ0RLIGFuZCB1dGlsaXR5IG1vZHVsZXNcbmltcG9ydCB7IElDZXJ0aWZpY2F0ZSB9IGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtY2VydGlmaWNhdGVtYW5hZ2VyXCI7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0IHsgbWVyZ2UgfSBmcm9tIFwidHMtZGVlcG1lcmdlXCI7XG5pbXBvcnQgKiBhcyBkb3QgZnJvbSAnZG90LW9iamVjdCc7XG5pbXBvcnQgeyBkZXBlbmRhYmxlLCBzdXBwb3J0c0FMTCB9IGZyb20gXCIuLi8uLi91dGlsc1wiO1xuaW1wb3J0IHsgc2V0UGF0aCB9IGZyb20gXCIuLi8uLi91dGlscy9vYmplY3QtdXRpbHNcIjtcbmltcG9ydCB7IENsdXN0ZXJJbmZvLCBWYWx1ZXMgfSBmcm9tIFwiLi4vLi4vc3BpXCI7XG5pbXBvcnQgeyBIZWxtQWRkT24sIEhlbG1BZGRPblByb3BzLCBIZWxtQWRkT25Vc2VyUHJvcHMgfSBmcm9tIFwiLi4vaGVsbS1hZGRvblwiO1xuaW1wb3J0IHsgQXdzTG9hZEJhbGFuY2VyQ29udHJvbGxlckFkZE9uIH0gZnJvbSBcIi4uXCI7XG5cbi8qKlxuICogUHJvcGVydGllcyBhdmFpbGFibGUgdG8gY29uZmlndXJlIHRoZSBuZ2lueCBpbmdyZXNzIGNvbnRyb2xsZXIuXG4gKiBWYWx1ZXMgdG8gcGFzcyB0byB0aGUgY2hhcnQgYXMgcGVyIGh0dHBzOi8va3ViZXJuZXRlcy5naXRodWIuaW8vaW5ncmVzcy1uZ2lueC91c2VyLWd1aWRlL25naW54LWNvbmZpZ3VyYXRpb24vYW5ub3RhdGlvbnMvXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgSW5ncmVzc05naW54QWRkT25Qcm9wcyBleHRlbmRzIEhlbG1BZGRPblVzZXJQcm9wcyB7XG4gICAgLyoqXG4gICAgICogVGhlIG5hbWUgb2YgdGhlIEt1YmVybmV0ZXMgSW5ncmVzcyBIZWxtIHJlbGVhc2UuXG4gICAgICovXG4gICAgbmFtZT86IHN0cmluZztcblxuICAgIC8qKlxuICAgICAqIFRoZSBuYW1lIG9mIHRoZSBjaGFydCB3aXRoaW4gdGhlIEhlbG0gcmVsZWFzZS5cbiAgICAgKi9cbiAgICBjaGFydD86IHN0cmluZztcblxuICAgIC8qKlxuICAgICAqIFVuaXF1ZSBpZGVudGlmaWVyIGZvciB0aGUgcmVsZWFzZS5cbiAgICAgKi9cbiAgICByZWxlYXNlPzogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICogU3BlY2lmaWMgdmVyc2lvbiBvZiB0aGUgY2hhcnQgdG8gYmUgZGVwbG95ZWQuXG4gICAgICovXG4gICAgdmVyc2lvbj86IHN0cmluZztcblxuICAgIC8qKlxuICAgICAqIFVSTCBvZiB0aGUgY2hhcnQgcmVwb3NpdG9yeS5cbiAgICAgKi9cbiAgICByZXBvc2l0b3J5Pzogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICogS3ViZXJuZXRlcyBuYW1lc3BhY2Ugd2hlcmUgdGhlIGluZ3Jlc3MgY29udHJvbGxlciB3aWxsIGJlIGluc3RhbGxlZC5cbiAgICAgKiBAZGVmYXVsdCAna3ViZS1zeXN0ZW0nXG4gICAgICovXG4gICAgbmFtZXNwYWNlPzogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICogQ3VzdG9tIHZhbHVlcyBwYXNzZWQgdG8gdGhlIEhlbG0gY2hhcnQuXG4gICAgICovXG4gICAgdmFsdWVzPzogVmFsdWVzO1xuXG4gICAgLyoqXG4gICAgICogU3BlY2lmaWVzIHRoZSBwcm90b2NvbCB1c2VkIGJ5IHRoZSBsb2FkIGJhbGFuY2VyLlxuICAgICAqIEhUVFAsIEhUVFBTLCBBVVRPX0hUVFAsIEdSUEMsIEdSUENTLCBhbmQgRkNHSSBhcmUgc3VwcG9ydGVkLlxuICAgICAqIEBkZWZhdWx0ICdodHRwJ1xuICAgICAqL1xuICAgIGJhY2tlbmRQcm90b2NvbD86IHN0cmluZztcblxuICAgIC8qKlxuICAgICAqIERldGVybWluZXMgd2hldGhlciBjcm9zcy16b25lIGxvYWQgYmFsYW5jaW5nIGlzIGVuYWJsZWQgZm9yIHRoZSBsb2FkIGJhbGFuY2VyLlxuICAgICAqIEBkZWZhdWx0IHRydWVcbiAgICAgKi9cbiAgICBjcm9zc1pvbmVFbmFibGVkPzogYm9vbGVhbjtcblxuICAgIC8qKlxuICAgICAqIEluZGljYXRlcyB3aGV0aGVyIHRoZSBsb2FkIGJhbGFuY2VyIGlzIGV4cG9zZWQgdG8gdGhlIGludGVybmV0LlxuICAgICAqIFNldCB0byBmYWxzZSBmb3IgYW4gaW50ZXJuYWwgbG9hZCBiYWxhbmNlci5cbiAgICAgKiBAZGVmYXVsdCB0cnVlXG4gICAgICovXG4gICAgaW50ZXJuZXRGYWNpbmc/OiBib29sZWFuO1xuXG4gICAgLyoqXG4gICAgICogU3BlY2lmaWVzIGhvdyB0cmFmZmljIGlzIHJvdXRlZCB0byBwb2RzLiBDYW4gYmUgZWl0aGVyICdpcCcgb3IgJ2luc3RhbmNlJy5cbiAgICAgKiAnaXAnIG1vZGUgaXMgbW9yZSBwZXJmb3JtYW50IGFuZCByZXF1aXJlcyBWUEMtQ05JLlxuICAgICAqIEBkZWZhdWx0ICdpcCdcbiAgICAgKi9cbiAgICB0YXJnZXRUeXBlPzogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICogSG9zdG5hbWUgdG8gYmUgdXNlZCB3aXRoIGV4dGVybmFsIEROUyBzZXJ2aWNlcyBmb3IgYXV0b21hdGljIEROUyBjb25maWd1cmF0aW9uLlxuICAgICAqL1xuICAgIGV4dGVybmFsRG5zSG9zdG5hbWU/OiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBTcGVjaWZpZXMgdGhlIGNsYXNzIG9mIHRoZSBpbmdyZXNzIGNvbnRyb2xsZXIuIFVzZWQgdG8gZGlmZmVyZW50aWF0ZSBiZXR3ZWVuIG11bHRpcGxlIGluZ3Jlc3MgY29udHJvbGxlcnMuXG4gICAgICogQGRlZmF1bHQgJ25naW54J1xuICAgICAqL1xuICAgIGluZ3Jlc3NDbGFzc05hbWU/OiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBTcGVjaWZpZXMgdGhlIGNvbnRyb2xsZXIgY2xhc3MgdXNlZCBmb3IgaGFuZGxpbmcgaW5ncmVzcyBpbiBhIGNsdXN0ZXIuXG4gICAgICovXG4gICAgY29udHJvbGxlckNsYXNzPzogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICogSWRlbnRpZmllciB1c2VkIGZvciBsZWFkZXIgZWxlY3Rpb24gZHVyaW5nIHRoZSBkZXBsb3ltZW50IG9mIG11bHRpcGxlIGluZ3Jlc3MgY29udHJvbGxlcnMuXG4gICAgICovXG4gICAgZWxlY3Rpb25JZD86IHN0cmluZztcblxuICAgIC8qKlxuICAgICAqIERldGVybWluZXMgaWYgdGhlIGluZ3Jlc3MgY29udHJvbGxlciBzaG91bGQgYmUgc2V0IGFzIHRoZSBkZWZhdWx0IGNvbnRyb2xsZXIgZm9yIGhhbmRsaW5nIGluZ3Jlc3MgcmVzb3VyY2VzLlxuICAgICAqIEBkZWZhdWx0IGZhbHNlXG4gICAgICovXG4gICAgaXNEZWZhdWx0Q2xhc3M/OiBib29sZWFuO1xuXG4gICAgLyoqXG4gICAgICogTmFtZSBvZiB0aGUgY2VydGlmaWNhdGUge0BsaW5rIE5hbWVkUmVzb3VyY2VQcm92aWRlcn0gdG8gYmUgdXNlZCBmb3IgY2VydGlmaWNhdGUgbG9vayB1cC4gXG4gICAgICogQHNlZSB7QGxpbmsgSW1wb3J0Q2VydGlmaWNhdGVQcm92aWRlcn0gYW5kIHtAbGluayBDcmVhdGVDZXJ0aWZpY2F0ZVByb3ZpZGVyfSBmb3IgZXhhbXBsZXMgb2YgY2VydGlmaWNhdGUgcHJvdmlkZXJzLlxuICAgICAqL1xuICAgIGNlcnRpZmljYXRlUmVzb3VyY2VOYW1lPzogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICogQVJOIG9mIHRoZSBBV1MgQ2VydGlmaWNhdGUgTWFuYWdlciBjZXJ0aWZpY2F0ZSB0byBiZSB1c2VkIGZvciBIVFRQUy5cbiAgICAgKi9cbiAgICBjZXJ0aWZpY2F0ZVJlc291cmNlQVJOPzogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICogUHJvdG9jb2wgZm9yIHRoZSBsb2FkIGJhbGFuY2VyIFNTTCBwb3J0LlxuICAgICAqIEBkZWZhdWx0ICdodHRwcydcbiAgICAgKi9cbiAgICBzc2xQb3J0Pzogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICogUHJvdG9jb2wgZm9yIHRoZSBsb2FkIGJhbGFuY2VyIEhUVFAgdGFyZ2V0IHBvcnQuXG4gICAgICogQGRlZmF1bHQgJ2h0dHAnXG4gICAgICovXG4gICAgaHR0cFRhcmdldFBvcnQ/OiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBQcm90b2NvbCBmb3IgdGhlIGxvYWQgYmFsYW5jZXIgSFRUUFMgdGFyZ2V0IHBvcnQuXG4gICAgICogQGRlZmF1bHQgJ2h0dHBzJ1xuICAgICAqL1xuICAgIGh0dHBzVGFyZ2V0UG9ydD86IHN0cmluZztcblxuICAgIC8qKlxuICAgICAqIERldGVybWluZXMgaWYgU1NMIHJlZGlyZWN0aW9uIHNob3VsZCBiZSBmb3JjZWQuXG4gICAgICogQGRlZmF1bHQgdHJ1ZVxuICAgICAqL1xuICAgIGZvcmNlU1NMUmVkaXJlY3Q/OiBib29sZWFuO1xuXG4gICAgLyoqXG4gICAgICogVHlwZSBvZiB0aGUgbG9hZCBiYWxhbmNlci5cbiAgICAgKiBAZGVmYXVsdCAnZXh0ZXJuYWwnXG4gICAgICovXG4gICAgbG9hZEJhbGFuY2VyVHlwZT86IHN0cmluZztcblxuICAgIC8qKlxuICAgICAqIEFSTiBvZiB0aGUgQVdTIENlcnRpZmljYXRlIE1hbmFnZXIgY2VydGlmaWNhdGUgdG8gYmUgdXNlZCBmb3IgSFRUUFMuXG4gICAgICogQGRlZmF1bHQgXCIzNjAwXCJcbiAgICAgKi9cbiAgICBpZGxlVGltZW91dD86IHN0cmluZztcblxuICAgIC8qKlxuICAgICAqIEt1YmVybmV0ZXMgc2VydmljZSB0eXBlIGZvciB0aGUgaW5ncmVzcyBjb250cm9sbGVyLiBTdXBwb3J0ZWQgdmFsdWVzIGFyZSAnQ2x1c3RlcklQJywgJ0xvYWRCYWxhbmNlcicgYW5kICdOb2RlUG9ydCcuXG4gICAgICogQGRlZmF1bHQgJ0xvYWRCYWxhbmNlcidcbiAgICAgKi9cbiAgICBzZXJ2aWNlVHlwZT86IHN0cmluZztcbn1cblxuLy8gU2V0IGRlZmF1bHQgcHJvcGVydGllcyBmb3IgdGhlIGFkZC1vblxuY29uc3QgZGVmYXVsdFByb3BzOiBJbmdyZXNzTmdpbnhBZGRPblByb3BzID0ge1xuICAgIG5hbWU6IFwia3ViZXJuZXRlcy1pbmdyZXNzXCIsXG4gICAgY2hhcnQ6IFwiaW5ncmVzcy1uZ2lueFwiLFxuICAgIHJlbGVhc2U6IFwiazhzLWluZ3Jlc3NcIixcbiAgICB2ZXJzaW9uOiBcIjQuMTAuMVwiLFxuICAgIHJlcG9zaXRvcnk6IFwiaHR0cHM6Ly9rdWJlcm5ldGVzLmdpdGh1Yi5pby9pbmdyZXNzLW5naW54XCIsXG4gICAgYmFja2VuZFByb3RvY29sOiAnaHR0cCcsXG4gICAgY3Jvc3Nab25lRW5hYmxlZDogdHJ1ZSxcbiAgICBpbnRlcm5ldEZhY2luZzogdHJ1ZSxcbiAgICB0YXJnZXRUeXBlOiAnaXAnLFxuICAgIG5hbWVzcGFjZTogJ2t1YmUtc3lzdGVtJyxcbiAgICBzc2xQb3J0OiAnaHR0cHMnLFxuICAgIGh0dHBUYXJnZXRQb3J0OiAnaHR0cCcsXG4gICAgaHR0cHNUYXJnZXRQb3J0OiAnaHR0cHMnLFxuICAgIGZvcmNlU1NMUmVkaXJlY3Q6IHRydWUsXG4gICAgbG9hZEJhbGFuY2VyVHlwZTogJ2V4dGVybmFsJyxcbiAgICBzZXJ2aWNlVHlwZTogXCJMb2FkQmFsYW5jZXJcIixcbiAgICBpZGxlVGltZW91dDogJzM2MDAnXG59O1xuXG4vLyBEZWZpbmUgdGhlIGNsYXNzIGZvciB0aGUgS3ViZXJuZXRlcyBJbmdyZXNzIEFkZC1PbiwgZXh0ZW5kaW5nIEhlbG1BZGRPblxuQHN1cHBvcnRzQUxMXG5leHBvcnQgY2xhc3MgSW5ncmVzc05naW54QWRkT24gZXh0ZW5kcyBIZWxtQWRkT24ge1xuICAgIHByaXZhdGUgcmVhZG9ubHkgb3B0aW9uczogSW5ncmVzc05naW54QWRkT25Qcm9wcztcblxuICAgIC8vIENvbnN0cnVjdG9yIGZvciB0aGUgY2xhc3MsIG1lcmdpbmcgZGVmYXVsdCBwcm9wcyB3aXRoIHVzZXItZGVmaW5lZCBwcm9wc1xuICAgIGNvbnN0cnVjdG9yKHByb3BzPzogSW5ncmVzc05naW54QWRkT25Qcm9wcykge1xuICAgICAgICBzdXBlcih7IC4uLmRlZmF1bHRQcm9wcywgLi4ucHJvcHMgfSBhcyBIZWxtQWRkT25Qcm9wcyk7XG4gICAgICAgIHRoaXMub3B0aW9ucyA9IHsgLi4uZGVmYXVsdFByb3BzLCAuLi5wcm9wcyB9IGFzIEluZ3Jlc3NOZ2lueEFkZE9uUHJvcHM7XG4gICAgfVxuXG4gICAgLy8gRGVwZW5kZW5jeSBkZWNvcmF0b3IgdG8gZW5zdXJlIHRoaXMgYWRkLW9uIGlzIGRlcGxveWVkIGFmdGVyIHRoZSBBV1MgTG9hZCBCYWxhbmNlciBDb250cm9sbGVyXG4gICAgQGRlcGVuZGFibGUoQXdzTG9hZEJhbGFuY2VyQ29udHJvbGxlckFkZE9uLm5hbWUpXG4gICAgYXN5bmMgZGVwbG95KGNsdXN0ZXJJbmZvOiBDbHVzdGVySW5mbyk6IFByb21pc2U8Q29uc3RydWN0PiB7XG4gICAgICAgIGNvbnN0IHByb3BzID0gdGhpcy5vcHRpb25zO1xuXG4gICAgICAgIC8vIFNldHVwIHNlcnZpY2UgYW5ub3RhdGlvbnMgYmFzZWQgb24gdGhlIHByb3BlcnRpZXMgcHJvdmlkZWRcbiAgICAgICAgY29uc3QgbG9hZEJhbGFuY2VyQW5ub3RhdGlvbnM6IGFueSA9IHtcbiAgICAgICAgICAgICdzZXJ2aWNlLmJldGEua3ViZXJuZXRlcy5pby9hd3MtbG9hZC1iYWxhbmNlci1iYWNrZW5kLXByb3RvY29sJzogcHJvcHMuYmFja2VuZFByb3RvY29sLFxuICAgICAgICAgICAgJ3NlcnZpY2UuYmV0YS5rdWJlcm5ldGVzLmlvL2F3cy1sb2FkLWJhbGFuY2VyLWF0dHJpYnV0ZXMnOiBgbG9hZF9iYWxhbmNpbmcuY3Jvc3Nfem9uZS5lbmFibGVkPSR7cHJvcHMuY3Jvc3Nab25lRW5hYmxlZH1gLFxuICAgICAgICAgICAgJ3NlcnZpY2UuYmV0YS5rdWJlcm5ldGVzLmlvL2F3cy1sb2FkLWJhbGFuY2VyLXNjaGVtZSc6IHByb3BzLmludGVybmV0RmFjaW5nID8gJ2ludGVybmV0LWZhY2luZycgOiAnaW50ZXJuYWwnLFxuICAgICAgICAgICAgJ3NlcnZpY2UuYmV0YS5rdWJlcm5ldGVzLmlvL2F3cy1sb2FkLWJhbGFuY2VyLXR5cGUnOiBwcm9wcy5sb2FkQmFsYW5jZXJUeXBlLFxuICAgICAgICAgICAgJ3NlcnZpY2UuYmV0YS5rdWJlcm5ldGVzLmlvL2F3cy1sb2FkLWJhbGFuY2VyLW5sYi10YXJnZXQtdHlwZSc6IHByb3BzLnRhcmdldFR5cGUsXG4gICAgICAgICAgICAnZXh0ZXJuYWwtZG5zLmFscGhhLmt1YmVybmV0ZXMuaW8vaG9zdG5hbWUnOiBwcm9wcy5leHRlcm5hbERuc0hvc3RuYW1lLFxuICAgICAgICAgICAgJ3NlcnZpY2UuYmV0YS5rdWJlcm5ldGVzLmlvL2F3cy1sb2FkLWJhbGFuY2VyLWNvbm5lY3Rpb24taWRsZS10aW1lb3V0JzogJzM2MDAnXG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gRGVmaW5lIHZhbHVlcyBmb3IgSGVsbSBjaGFydCBiYXNlZCBvbiBwcm9wZXJ0aWVzIGFuZCBhbm5vdGF0aW9uc1xuICAgICAgICBjb25zdCB2YWx1ZXM6IFZhbHVlcyA9IHtcbiAgICAgICAgICAgIGNvbnRyb2xsZXI6IHtcbiAgICAgICAgICAgICAgICBzZXJ2aWNlOiB7XG4gICAgICAgICAgICAgICAgICAgIGFubm90YXRpb25zOiBwcm9wcy5zZXJ2aWNlVHlwZSA9PSAnTG9hZEJhbGFuY2VyJyA/IGxvYWRCYWxhbmNlckFubm90YXRpb25zIDoge31cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGluZ3Jlc3NDbGFzc1Jlc291cmNlOiB7XG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IHByb3BzLmluZ3Jlc3NDbGFzc05hbWUgfHwgXCJpbmdyZXNzLW5naW54XCIsXG4gICAgICAgICAgICAgICAgICAgIGVuYWJsZWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6IHByb3BzLmlzRGVmYXVsdENsYXNzID8/IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyVmFsdWU6IHByb3BzLmNvbnRyb2xsZXJDbGFzcyB8fCBcIms4cy5pby9pbmdyZXNzLW5naW54XCJcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGVsZWN0aW9uSUQ6IHByb3BzLmVsZWN0aW9uSWQgfHwgXCJpbmdyZXNzLWNvbnRyb2xsZXItbGVhZGVyXCJcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICAvLyBDb21iaW5lIGxvZ2ljIGZvciBoYW5kbGluZyBjZXJ0aWZpY2F0ZSBhbm5vdGF0aW9uc1xuICAgICAgICBsZXQgY2VydGlmaWNhdGVSZXNvdXJjZUFSTiA9IHByb3BzLmNlcnRpZmljYXRlUmVzb3VyY2VBUk47XG5cbiAgICAgICAgaWYgKCFjZXJ0aWZpY2F0ZVJlc291cmNlQVJOICYmIHByb3BzLmNlcnRpZmljYXRlUmVzb3VyY2VOYW1lKSB7XG4gICAgICAgICAgICBjb25zdCBjZXJ0aWZpY2F0ZSA9IGNsdXN0ZXJJbmZvLmdldFJlc291cmNlPElDZXJ0aWZpY2F0ZT4ocHJvcHMuY2VydGlmaWNhdGVSZXNvdXJjZU5hbWUpO1xuICAgICAgICAgICAgY2VydGlmaWNhdGVSZXNvdXJjZUFSTiA9IGNlcnRpZmljYXRlPy5jZXJ0aWZpY2F0ZUFybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjZXJ0aWZpY2F0ZVJlc291cmNlQVJOKSB7XG4gICAgICAgICAgICBsb2FkQmFsYW5jZXJBbm5vdGF0aW9uc1snc2VydmljZS5iZXRhLmt1YmVybmV0ZXMuaW8vYXdzLWxvYWQtYmFsYW5jZXItc3NsLXBvcnRzJ10gPSBwcm9wcy5zc2xQb3J0O1xuICAgICAgICAgICAgbG9hZEJhbGFuY2VyQW5ub3RhdGlvbnNbJ3NlcnZpY2UuYmV0YS5rdWJlcm5ldGVzLmlvL2F3cy1sb2FkLWJhbGFuY2VyLXNzbC1jZXJ0J10gPSBjZXJ0aWZpY2F0ZVJlc291cmNlQVJOO1xuICAgICAgICAgICAgaWYgKHByb3BzLmZvcmNlU1NMUmVkaXJlY3QpIHtcbiAgICAgICAgICAgICAgICBsb2FkQmFsYW5jZXJBbm5vdGF0aW9uc1snbmdpbnguaW5ncmVzcy5rdWJlcm5ldGVzLmlvL2ZvcmNlLXNzbC1yZWRpcmVjdCddID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFNldCBIVFRQIGFuZCBIVFRQUyB0YXJnZXQgcG9ydHNcbiAgICAgICAgc2V0UGF0aCh2YWx1ZXMsIFwiY29udHJvbGxlci5zZXJ2aWNlLnRhcmdldFBvcnRzLmh0dHBcIiwgcHJvcHMuaHR0cFRhcmdldFBvcnQpO1xuICAgICAgICBjb25zdCBodHRwc1RhcmdldFBvcnQgPSBkb3QucGljayhcImNvbnRyb2xsZXIuc2VydmljZS50YXJnZXRQb3J0cy5odHRwc1wiLCBwcm9wcy52YWx1ZXMpIHx8IHByb3BzLmh0dHBzVGFyZ2V0UG9ydDtcbiAgICAgICAgc2V0UGF0aCh2YWx1ZXMsIFwiY29udHJvbGxlci5zZXJ2aWNlLnRhcmdldFBvcnRzLmh0dHBzXCIsIGh0dHBzVGFyZ2V0UG9ydCk7XG5cbiAgICAgICAgLy8gTWVyZ2UgdXNlci1kZWZpbmVkIHZhbHVlcyB3aXRoIGRlZmF1bHRzIGZvciB0aGUgSGVsbSBjaGFydCBkZXBsb3ltZW50XG4gICAgICAgIGNvbnN0IG1lcmdlZFZhbHVlcyA9IG1lcmdlKHZhbHVlcywgdGhpcy5wcm9wcy52YWx1ZXMgPz8ge30pO1xuICAgICAgICBjb25zdCBuZ2lueEhlbG1DaGFydCA9IHRoaXMuYWRkSGVsbUNoYXJ0KGNsdXN0ZXJJbmZvLCBtZXJnZWRWYWx1ZXMpO1xuXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUobmdpbnhIZWxtQ2hhcnQpO1xuICAgIH1cbn1cbiJdfQ==