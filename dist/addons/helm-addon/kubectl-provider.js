"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.KubectlProvider = void 0;
const aws_eks_1 = require("aws-cdk-lib/aws-eks");
/**
 * Kubectl provider for the add-ons and teams that is capable of helm and generic manifest deployments.
 * It exposes extension mechanism and central points for logging, stack output, extension of functionality.
 */
class KubectlProvider {
    constructor(clusterInfo) {
        this.clusterInfo = clusterInfo;
    }
    addHelmChart(props) {
        return KubectlProvider.applyHelmDeployment(this.clusterInfo, props);
    }
    addManifest(props) {
        return KubectlProvider.applyManifestDeployment(this.clusterInfo, props);
    }
}
exports.KubectlProvider = KubectlProvider;
KubectlProvider.applyHelmDeployment = function (clusterInfo, props) {
    return clusterInfo.cluster.addHelmChart(props.name, {
        repository: props.repository,
        namespace: props.namespace,
        createNamespace: props.createNamespace,
        chart: props.chart,
        version: props.version,
        release: props.release,
        timeout: props.timeout,
        wait: props.wait,
        values: props.values
    });
};
/**
 * Simple template provider for manifest based add-ons.
 * Replaces values in format {{key}} with the values passed in as values.
 * @param document where templated parameters must be replaced
 * @param values values to replace (e.g. region will be passed as "region: us-west-1" and any occurrence of {{region}} will be replaced)
 * @returns
 */
KubectlProvider.applyManifestTemplate = function (document, values) {
    const valueMap = new Map(Object.entries(values));
    let data = JSON.stringify(document);
    valueMap.forEach((value, key) => {
        data = data.replace(new RegExp(`{{${key}}}`, 'g'), value);
    });
    return JSON.parse(data);
};
KubectlProvider.applyManifestDeployment = function (clusterInfo, props) {
    const manifestDoc = KubectlProvider.applyManifestTemplate(props.manifest, props.values);
    return new aws_eks_1.KubernetesManifest(clusterInfo.cluster, props.name, {
        cluster: clusterInfo.cluster,
        manifest: manifestDoc,
        overwrite: true
    });
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoia3ViZWN0bC1wcm92aWRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9hZGRvbnMvaGVsbS1hZGRvbi9rdWJlY3RsLXByb3ZpZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLGlEQUF5RDtBQTRHekQ7OztHQUdHO0FBQ0gsTUFBYSxlQUFlO0lBRXhCLFlBQTZCLFdBQXdCO1FBQXhCLGdCQUFXLEdBQVgsV0FBVyxDQUFhO0lBQUksQ0FBQztJQXlDbkQsWUFBWSxDQUFDLEtBQTBCO1FBQzFDLE9BQU8sZUFBZSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDeEUsQ0FBQztJQUVNLFdBQVcsQ0FBQyxLQUF5QjtRQUN4QyxPQUFPLGVBQWUsQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQzVFLENBQUM7O0FBakRMLDBDQWtEQztBQTlDaUIsbUNBQW1CLEdBQUcsVUFBVSxXQUF3QixFQUFFLEtBQTBCO0lBQzlGLE9BQU8sV0FBVyxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRTtRQUNoRCxVQUFVLEVBQUUsS0FBSyxDQUFDLFVBQVU7UUFDNUIsU0FBUyxFQUFFLEtBQUssQ0FBQyxTQUFTO1FBQzFCLGVBQWUsRUFBRSxLQUFLLENBQUMsZUFBZTtRQUN0QyxLQUFLLEVBQUUsS0FBSyxDQUFDLEtBQUs7UUFDbEIsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPO1FBQ3RCLE9BQU8sRUFBRSxLQUFLLENBQUMsT0FBTztRQUN0QixPQUFPLEVBQUUsS0FBSyxDQUFDLE9BQU87UUFDdEIsSUFBSSxFQUFFLEtBQUssQ0FBQyxJQUFJO1FBQ2hCLE1BQU0sRUFBRSxLQUFLLENBQUMsTUFBTTtLQUN2QixDQUFDLENBQUM7QUFDUCxDQUFDLENBQUM7QUFFRjs7Ozs7O0dBTUc7QUFDVyxxQ0FBcUIsR0FBRyxVQUFVLFFBQWEsRUFBRSxNQUFjO0lBQ3pFLE1BQU0sUUFBUSxHQUFHLElBQUksR0FBRyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztJQUNqRCxJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ3BDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFVLEVBQUUsR0FBVyxFQUFFLEVBQUU7UUFDekMsSUFBSSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxNQUFNLENBQUMsS0FBSyxHQUFHLElBQUksRUFBRSxHQUFHLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUM5RCxDQUFDLENBQUMsQ0FBQztJQUNILE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUM1QixDQUFDLENBQUM7QUFFWSx1Q0FBdUIsR0FBRyxVQUFVLFdBQXdCLEVBQUUsS0FBeUI7SUFDakcsTUFBTSxXQUFXLEdBQUcsZUFBZSxDQUFDLHFCQUFxQixDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3hGLE9BQU8sSUFBSSw0QkFBa0IsQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxJQUFJLEVBQUU7UUFDM0QsT0FBTyxFQUFFLFdBQVcsQ0FBQyxPQUFPO1FBQzVCLFFBQVEsRUFBRSxXQUFXO1FBQ3JCLFNBQVMsRUFBRSxJQUFJO0tBQ2xCLENBQUMsQ0FBQztBQUNQLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEt1YmVybmV0ZXNNYW5pZmVzdCB9IGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtZWtzXCI7XG5pbXBvcnQgeyBEdXJhdGlvbiB9IGZyb20gXCJhd3MtY2RrLWxpYlwiO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSBcImNvbnN0cnVjdHNcIjtcbmltcG9ydCB7IENsdXN0ZXJJbmZvLCBWYWx1ZXMgfSBmcm9tIFwiLi4vLi5cIjtcblxuLyoqXG4gKiBTdHJ1Y3R1cmUgdGhhdCBkZWZpbmVzIHByb3BlcnRpZXMgZm9yIGEgZ2VuZXJpYyBIZWxtIGNoYXJ0LiBcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBIZWxtQ2hhcnRDb25maWd1cmF0aW9uIHtcblxuICAgIC8qKlxuICAgICAqIE5hbWUgb2YgdGhlIGhlbG0gY2hhcnQgKGFkZC1vbilcbiAgICAgKi9cbiAgICBuYW1lOiBzdHJpbmcsXG5cbiAgICAvKipcbiAgICAgKiBOYW1lc3BhY2Ugd2hlcmUgaGVsbSByZWxlYXNlIHdpbGwgYmUgaW5zdGFsbGVkXG4gICAgICovXG4gICAgbmFtZXNwYWNlOiBzdHJpbmcgfCB1bmRlZmluZWQsXG5cbiAgICAvKipcbiAgICAgKiBDaGFydCBuYW1lXG4gICAgICovXG4gICAgY2hhcnQ6IHN0cmluZyxcblxuICAgIC8qKlxuICAgICAqIEhlbG0gY2hhcnQgdmVyc2lvbi5cbiAgICAgKi9cbiAgICB2ZXJzaW9uOiBzdHJpbmcsXG5cbiAgICAvKipcbiAgICAgKiBIZWxtIHJlbGVhc2VcbiAgICAgKi9cbiAgICByZWxlYXNlOiBzdHJpbmcsXG5cbiAgICAvKipcbiAgICAgKiBIZWxtIHJlcG9zaXRvcnlcbiAgICAgKi9cbiAgICByZXBvc2l0b3J5Pzogc3RyaW5nLFxuXG4gICAgLyoqXG4gICAgICogV2hlbiBnbG9iYWwgaGVsbSB2ZXJzaW9uIHZhbGlkYXRpb24gaXMgZW5hYmxlZCB3aXRoIEhlbG1BZGRPbi52YWxpZGF0ZUhlbG1WZXJzaW9ucyA9IHRydWVcbiAgICAgKiBhbGxvd3MgdG8gc2tpcCB2YWxpZGF0aW9uIGZvciBhIHBhcnRpY3VsYXIgaGVsbSBhZGQtb24uIFxuICAgICAqL1xuICAgIHNraXBWZXJzaW9uVmFsaWRhdGlvbj86IGJvb2xlYW4sXG5cbiAgICAvKipcbiAgICAgKiBPcHRpb25hbCB2YWx1ZXMgZm9yIHRoZSBoZWxtIGNoYXJ0LiBcbiAgICAgKi9cbiAgICB2YWx1ZXM/OiBWYWx1ZXNcblxuICAgIC8qKlxuICAgICAqIEluZGljYXRlIHRoZSBoZWxtIGNoYXJ0IHByb3ZpZGVkIHVzZXMgZGVwZW5kZW5jeSBtb2RlIChodHRwczovL2hlbG0uc2gvZG9jcy9oZWxtL2hlbG1fZGVwZW5kZW5jeS8pLlxuICAgICAqIERlcGVuZGVuY3kgbW9kZSBpcyB3aWRlbHkgdXNlZCBpbiBgYXdzLXNhbXBsZXMvZWtzLWJsdWVwcmludHMtYWRkLW9uc2AgcmVwb3NpdG9yeSwgZm9yIGV4YW1wbGU6XG4gICAgICogaHR0cHM6Ly9naXRodWIuY29tL2F3cy1zYW1wbGVzL2Vrcy1ibHVlcHJpbnRzLWFkZC1vbnMvYmxvYi9tYWluL2FkZC1vbnMvYXBwbWVzaC1jb250cm9sbGVyL0NoYXJ0LnlhbWxcbiAgICAgKiBEZXBlbmRlbmN5IG1vZGUgcmVxdWlyZXMgdGhlIGNoYXJ0IHZhbHVlcyB0byBiZSB3cmFwcGVkIHdpdGhpbiB0aGUgY2hhcnQgbmFtZS5cbiAgICAgKiBUaGlzIHZhbHVlIGlzIG9ubHkgdXNlZCB0byB0dXJuIG9mZiBkZXBlbmRlbmN5IG1vZGUgaW4gY2FzZSBjdXN0b21lcnMgY2hvb3NlIHRvIGNvcHkgdGhlIHdob2xlIGhlbG0gY2hhcnQgaW50byB0aGVpciByZXBvXG4gICAgICogQGRlZmF1bHQgdHJ1ZVxuICAgICAqL1xuICAgIGRlcGVuZGVuY3lNb2RlPzogYm9vbGVhblxufVxuXG4vKipcbiAqIEV4dGVuZHMgaGVsbSBjaGFydCBjb25maWd1cmF0aW9uIChyZXBvL2NoYXJ0KSB3aXRoIGRlcGxveW1lbnQgcGFyYW1ldGVyczogdmFsdWVzLCB0aW1lb3V0IGFuZCB3YWl0LlxuICovXG5leHBvcnQgaW50ZXJmYWNlIEhlbG1DaGFydERlcGxveW1lbnQgZXh0ZW5kcyBSZXF1aXJlZDxPbWl0PEhlbG1DaGFydENvbmZpZ3VyYXRpb24sIFwic2tpcFZlcnNpb25WYWxpZGF0aW9uXCIgfCBcInJlcG9zaXRvcnlcIj4+IHtcblxuICAgIC8qKlxuICAgICAqIEhlbG0gUmVwb3NpdG9yeVxuICAgICAqL1xuICAgIHJlcG9zaXRvcnk/OiBzdHJpbmc7XG4gICAgXG4gICAgLyoqXG4gICAgICogRGVwbG95bWVudCB3aWxsIHdhaXQgZm9yIGFsbCBwb2RzIHRvIGNvbWUgdXAuXG4gICAgICovXG4gICAgd2FpdD86IGJvb2xlYW47XG5cbiAgICAvKipcbiAgICAgKiBUaW1lIHRvIHdhaXQuIFxuICAgICAqL1xuICAgIHRpbWVvdXQ/OiBEdXJhdGlvbjtcblxuICAgIC8qKlxuICAgICAqIENyZWF0ZXMgbmFtZXNwYWNlIGlmIGRvZXMgbm90IGV4aXN0XG4gICAgICovXG4gICAgY3JlYXRlTmFtZXNwYWNlPzogYm9vbGVhbjtcbn1cblxuLyoqXG4gKiBEYXRhIHN0cnVjdHVyZSBkZWZpbmVzIHByb3BlcnRpZXMgZm9yIGt1YmVybmV0ZXMgbWFuaWZlc3QgZGVwbG95bWVudCAobm9uLWhlbG0pLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIE1hbmlmZXN0Q29uZmlndXJhdGlvbiB7XG4gICAgbmFtZTogc3RyaW5nLFxuICAgIG5hbWVzcGFjZTogc3RyaW5nLFxuICAgIG1hbmlmZXN0VXJsOiBzdHJpbmdcbn1cblxuLyoqXG4gKiBEYXRhIHN0cnVjdHVyZSBleHRlbmRzIEt1YmVybmV0ZXMgbWFuaWZlc3QgY29uZmlndXJhdGlvbiBhbmQgYWxsb3dzIHBhc3NpbmcgZGVwbG95bWVudCBwYXJhbWV0ZXJzLlxuICogU3VjaCBwYXJhbWV0ZXJzIGFyZSBleHBlY3RlZCB0byBiZSB0ZW1wbGF0ZWQgd2l0aGluIHZhbHVlcyBpbnNpZGUgdGhlIG1hbmlmZXN0IGFzIHt7cGFyYW1ldGVyLWtleX19LlxuICogRm9yIGV4YW1wbGUsIGlmIHZhbHVlcyBjb250YWlucyB7cmVnaW9uOiAndXMtZWFzdC0yJ30gdGhlbiB0aGUgbWFuaWZlc3QgaXMgZXhwZWN0ZWQgdG8gY29udGFpbiBcbiAqIHsgJ3NvbWUtYXR0cmlidXRlJyA6IHt7cmVnaW9ufX0uXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgTWFuaWZlc3REZXBsb3ltZW50IGV4dGVuZHMgT21pdDxNYW5pZmVzdENvbmZpZ3VyYXRpb24sIFwibWFuaWZlc3RVcmxcIj4ge1xuICAgIG1hbmlmZXN0OiBhbnksXG4gICAgdmFsdWVzOiBWYWx1ZXNcbn1cblxuLyoqXG4gKiBLdWJlY3RsIHByb3ZpZGVyIGZvciB0aGUgYWRkLW9ucyBhbmQgdGVhbXMgdGhhdCBpcyBjYXBhYmxlIG9mIGhlbG0gYW5kIGdlbmVyaWMgbWFuaWZlc3QgZGVwbG95bWVudHMuXG4gKiBJdCBleHBvc2VzIGV4dGVuc2lvbiBtZWNoYW5pc20gYW5kIGNlbnRyYWwgcG9pbnRzIGZvciBsb2dnaW5nLCBzdGFjayBvdXRwdXQsIGV4dGVuc2lvbiBvZiBmdW5jdGlvbmFsaXR5LlxuICovXG5leHBvcnQgY2xhc3MgS3ViZWN0bFByb3ZpZGVyIHtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgY2x1c3RlckluZm86IENsdXN0ZXJJbmZvKSB7IH1cblxuICAgIHB1YmxpYyBzdGF0aWMgYXBwbHlIZWxtRGVwbG95bWVudCA9IGZ1bmN0aW9uIChjbHVzdGVySW5mbzogQ2x1c3RlckluZm8sIHByb3BzOiBIZWxtQ2hhcnREZXBsb3ltZW50KTogQ29uc3RydWN0IHtcbiAgICAgICAgcmV0dXJuIGNsdXN0ZXJJbmZvLmNsdXN0ZXIuYWRkSGVsbUNoYXJ0KHByb3BzLm5hbWUsIHtcbiAgICAgICAgICAgIHJlcG9zaXRvcnk6IHByb3BzLnJlcG9zaXRvcnksXG4gICAgICAgICAgICBuYW1lc3BhY2U6IHByb3BzLm5hbWVzcGFjZSxcbiAgICAgICAgICAgIGNyZWF0ZU5hbWVzcGFjZTogcHJvcHMuY3JlYXRlTmFtZXNwYWNlLFxuICAgICAgICAgICAgY2hhcnQ6IHByb3BzLmNoYXJ0LFxuICAgICAgICAgICAgdmVyc2lvbjogcHJvcHMudmVyc2lvbixcbiAgICAgICAgICAgIHJlbGVhc2U6IHByb3BzLnJlbGVhc2UsXG4gICAgICAgICAgICB0aW1lb3V0OiBwcm9wcy50aW1lb3V0LFxuICAgICAgICAgICAgd2FpdDogcHJvcHMud2FpdCxcbiAgICAgICAgICAgIHZhbHVlczogcHJvcHMudmFsdWVzXG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICAvKipcbiAgICAgKiBTaW1wbGUgdGVtcGxhdGUgcHJvdmlkZXIgZm9yIG1hbmlmZXN0IGJhc2VkIGFkZC1vbnMuIFxuICAgICAqIFJlcGxhY2VzIHZhbHVlcyBpbiBmb3JtYXQge3trZXl9fSB3aXRoIHRoZSB2YWx1ZXMgcGFzc2VkIGluIGFzIHZhbHVlcy5cbiAgICAgKiBAcGFyYW0gZG9jdW1lbnQgd2hlcmUgdGVtcGxhdGVkIHBhcmFtZXRlcnMgbXVzdCBiZSByZXBsYWNlZFxuICAgICAqIEBwYXJhbSB2YWx1ZXMgdmFsdWVzIHRvIHJlcGxhY2UgKGUuZy4gcmVnaW9uIHdpbGwgYmUgcGFzc2VkIGFzIFwicmVnaW9uOiB1cy13ZXN0LTFcIiBhbmQgYW55IG9jY3VycmVuY2Ugb2Yge3tyZWdpb259fSB3aWxsIGJlIHJlcGxhY2VkKVxuICAgICAqIEByZXR1cm5zIFxuICAgICAqL1xuICAgIHB1YmxpYyBzdGF0aWMgYXBwbHlNYW5pZmVzdFRlbXBsYXRlID0gZnVuY3Rpb24gKGRvY3VtZW50OiBhbnksIHZhbHVlczogVmFsdWVzKTogYW55IHtcbiAgICAgICAgY29uc3QgdmFsdWVNYXAgPSBuZXcgTWFwKE9iamVjdC5lbnRyaWVzKHZhbHVlcykpO1xuICAgICAgICBsZXQgZGF0YSA9IEpTT04uc3RyaW5naWZ5KGRvY3VtZW50KTtcbiAgICAgICAgdmFsdWVNYXAuZm9yRWFjaCgodmFsdWU6IGFueSwga2V5OiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgIGRhdGEgPSBkYXRhLnJlcGxhY2UobmV3IFJlZ0V4cChge3ske2tleX19fWAsICdnJyksIHZhbHVlKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBKU09OLnBhcnNlKGRhdGEpO1xuICAgIH07XG5cbiAgICBwdWJsaWMgc3RhdGljIGFwcGx5TWFuaWZlc3REZXBsb3ltZW50ID0gZnVuY3Rpb24gKGNsdXN0ZXJJbmZvOiBDbHVzdGVySW5mbywgcHJvcHM6IE1hbmlmZXN0RGVwbG95bWVudCkge1xuICAgICAgICBjb25zdCBtYW5pZmVzdERvYyA9IEt1YmVjdGxQcm92aWRlci5hcHBseU1hbmlmZXN0VGVtcGxhdGUocHJvcHMubWFuaWZlc3QsIHByb3BzLnZhbHVlcyk7XG4gICAgICAgIHJldHVybiBuZXcgS3ViZXJuZXRlc01hbmlmZXN0KGNsdXN0ZXJJbmZvLmNsdXN0ZXIsIHByb3BzLm5hbWUsIHtcbiAgICAgICAgICAgIGNsdXN0ZXI6IGNsdXN0ZXJJbmZvLmNsdXN0ZXIsXG4gICAgICAgICAgICBtYW5pZmVzdDogbWFuaWZlc3REb2MsXG4gICAgICAgICAgICBvdmVyd3JpdGU6IHRydWVcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIHB1YmxpYyBhZGRIZWxtQ2hhcnQocHJvcHM6IEhlbG1DaGFydERlcGxveW1lbnQpOiBDb25zdHJ1Y3Qge1xuICAgICAgICByZXR1cm4gS3ViZWN0bFByb3ZpZGVyLmFwcGx5SGVsbURlcGxveW1lbnQodGhpcy5jbHVzdGVySW5mbywgcHJvcHMpO1xuICAgIH1cblxuICAgIHB1YmxpYyBhZGRNYW5pZmVzdChwcm9wczogTWFuaWZlc3REZXBsb3ltZW50KSA6IENvbnN0cnVjdCB7XG4gICAgICAgIHJldHVybiBLdWJlY3RsUHJvdmlkZXIuYXBwbHlNYW5pZmVzdERlcGxveW1lbnQodGhpcy5jbHVzdGVySW5mbywgcHJvcHMpO1xuICAgIH1cbn1cblxuXG4iXX0=