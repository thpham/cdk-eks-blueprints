"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.SecretProviderClass = exports.KubernetesSecretType = void 0;
const aws_cdk_lib_1 = require("aws-cdk-lib");
const assert = require("assert");
const __1 = require("../..");
var AwsSecretType;
(function (AwsSecretType) {
    AwsSecretType["SSMPARAMETER"] = "ssmparameter";
    AwsSecretType["SECRETSMANAGER"] = "secretsmanager";
})(AwsSecretType || (AwsSecretType = {}));
var KubernetesSecretType;
(function (KubernetesSecretType) {
    KubernetesSecretType["OPAQUE"] = "Opaque";
    KubernetesSecretType["BASIC_AUTH"] = "kubernetes.io/basic-auth";
    KubernetesSecretType["TOKEN"] = "bootstrap.kubernetes.io/token";
    KubernetesSecretType["DOCKER_CONFIG_JSON"] = "kubernetes.io/dockerconfigjson";
    KubernetesSecretType["DOCKER_CONFIG"] = "kubernetes.io/dockercfg";
    KubernetesSecretType["SSH_AUTH"] = "kubernetes.io/ssh-auth";
    KubernetesSecretType["SERVICE_ACCOUNT_TOKEN"] = "kubernetes.io/service-account-token";
    KubernetesSecretType["TLS"] = "kubernetes.io/tls";
})(KubernetesSecretType || (exports.KubernetesSecretType = KubernetesSecretType = {}));
function createParameterObject(csiSecret, secretName, secretType, secretAlias) {
    const result = {
        objectName: secretName,
        objectType: secretType,
    };
    if (csiSecret.jmesPath) {
        result.jmesPath = csiSecret.jmesPath;
    }
    if (secretAlias) {
        result.objectAlias = secretAlias;
    }
    return result;
}
class SecretProviderClass {
    constructor(clusterInfo, serviceAccount, secretProviderClassName, ...csiSecrets) {
        this.clusterInfo = clusterInfo;
        this.serviceAccount = serviceAccount;
        this.secretProviderClassName = secretProviderClassName;
        this.parameterObjects = [];
        this.kubernetesSecrets = [];
        this.csiSecrets = csiSecrets;
        this.secretProviderClassPromise = this.setupSecrets();
    }
    addDependent(...constructs) {
        this.secretProviderClassPromise.then(secretProviderClass => {
            constructs.forEach(dependent => dependent.node.addDependency(secretProviderClass));
        });
    }
    /**
     * Optionally returns volume mounts for a pod or helm chart that supports volume mounts.
     */
    getVolumeMounts(volumeName, mountPath) {
        return {
            "volumes": [
                {
                    name: volumeName,
                    csi: {
                        driver: "secrets-store.csi.k8s.io",
                        readOnly: true,
                        volumeAttributes: {
                            secretProviderClass: this.secretProviderClassName
                        }
                    }
                }
            ],
            "volumeMounts": [
                {
                    name: volumeName,
                    mountPath: mountPath !== null && mountPath !== void 0 ? mountPath : "/mnt/secret-store"
                }
            ]
        };
    }
    /**
     * Setup CSI secrets
     * @param clusterInfo
     */
    setupSecrets() {
        const secretsDriverPromise = this.clusterInfo.getScheduledAddOn(__1.SecretsStoreAddOn.name);
        assert(secretsDriverPromise != null, 'SecretsStoreAddOn is required to setup secrets but is not provided in the add-ons.');
        this.addPolicyToServiceAccount();
        // Create and apply SecretProviderClass manifest
        return secretsDriverPromise.then(secretsDriver => this.createSecretProviderClass(secretsDriver));
    }
    /**
     * Creates Service Account for CSI Secrets driver and sets up the IAM Policies
     * needed to access the AWS Secrets
     * @param clusterInfo
     * @param serviceAccount
     */
    addPolicyToServiceAccount() {
        this.csiSecrets.forEach((csiSecret) => {
            var _a, _b, _c;
            const data = [];
            let kubernetesSecret;
            let secretName;
            const secret = csiSecret.secretProvider.provide(this.clusterInfo);
            const secretAlias = (_a = csiSecret.kubernetesSecret) === null || _a === void 0 ? void 0 : _a.secretAlias;
            if (Object.hasOwnProperty.call(secret, 'secretArn')) {
                const secretManagerSecret = secret;
                secretName = secretManagerSecret.secretName;
                const parameterObject = createParameterObject(csiSecret, secretName, AwsSecretType.SECRETSMANAGER, secretAlias);
                this.parameterObjects.push(parameterObject);
                secretManagerSecret.grantRead(this.serviceAccount);
            }
            else {
                const ssmSecret = secret;
                secretName = ssmSecret.parameterName;
                const parameterObject = createParameterObject(csiSecret, secretName, AwsSecretType.SSMPARAMETER, secretAlias);
                this.parameterObjects.push(parameterObject);
                ssmSecret.grantRead(this.serviceAccount);
            }
            if (csiSecret.kubernetesSecret) {
                if (csiSecret.kubernetesSecret.data) {
                    csiSecret.kubernetesSecret.data.forEach((item) => {
                        var _a, _b;
                        const dataObject = {
                            objectName: (_a = item.objectName) !== null && _a !== void 0 ? _a : secretName,
                            key: (_b = item.key) !== null && _b !== void 0 ? _b : secretName
                        };
                        data.push(dataObject);
                    });
                }
                else {
                    const dataObject = {
                        objectName: secretName,
                        key: secretName
                    };
                    data.push(dataObject);
                }
                kubernetesSecret = {
                    secretName: csiSecret.kubernetesSecret.secretName,
                    type: (_b = csiSecret.kubernetesSecret.type) !== null && _b !== void 0 ? _b : KubernetesSecretType.OPAQUE,
                    labels: (_c = csiSecret.kubernetesSecret.labels) !== null && _c !== void 0 ? _c : undefined,
                    data,
                };
                this.kubernetesSecrets.push(kubernetesSecret);
            }
        });
    }
    /**
     * Create and apply the SecretProviderClass manifest
     * @param clusterInfo
     * @param serviceAccount
     * @param csiDriver
     */
    createSecretProviderClass(csiDriver) {
        const cluster = this.clusterInfo.cluster;
        const secretProviderClass = this.secretProviderClassName;
        const secretProviderClassManifest = cluster.addManifest(secretProviderClass, {
            apiVersion: 'secrets-store.csi.x-k8s.io/v1alpha1',
            kind: 'SecretProviderClass',
            metadata: {
                name: secretProviderClass,
                namespace: this.serviceAccount.serviceAccountNamespace
            },
            spec: {
                provider: 'aws',
                parameters: {
                    objects: JSON.stringify(this.parameterObjects),
                },
                secretObjects: this.kubernetesSecrets
            }
        });
        secretProviderClassManifest.node.addDependency(this.serviceAccount, csiDriver);
        new aws_cdk_lib_1.CfnOutput(cluster.stack, `${this.serviceAccount.serviceAccountName}-secret-provider-class `, {
            value: secretProviderClass
        });
        return secretProviderClassManifest;
    }
}
exports.SecretProviderClass = SecretProviderClass;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3NpLWRyaXZlci1wcm92aWRlci1hd3Mtc2VjcmV0cy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9hZGRvbnMvc2VjcmV0cy1zdG9yZS9jc2ktZHJpdmVyLXByb3ZpZGVyLWF3cy1zZWNyZXRzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUdBLDZDQUF3QztBQUV4QyxpQ0FBaUM7QUFDakMsNkJBQTBDO0FBNkUxQyxJQUFLLGFBR0o7QUFIRCxXQUFLLGFBQWE7SUFDZCw4Q0FBNkIsQ0FBQTtJQUM3QixrREFBaUMsQ0FBQTtBQUNyQyxDQUFDLEVBSEksYUFBYSxLQUFiLGFBQWEsUUFHakI7QUFFRCxJQUFZLG9CQVNYO0FBVEQsV0FBWSxvQkFBb0I7SUFDNUIseUNBQWlCLENBQUE7SUFDakIsK0RBQXVDLENBQUE7SUFDdkMsK0RBQXVDLENBQUE7SUFDdkMsNkVBQXFELENBQUE7SUFDckQsaUVBQXlDLENBQUE7SUFDekMsMkRBQW1DLENBQUE7SUFDbkMscUZBQTZELENBQUE7SUFDN0QsaURBQXlCLENBQUE7QUFDN0IsQ0FBQyxFQVRXLG9CQUFvQixvQ0FBcEIsb0JBQW9CLFFBUy9CO0FBU0QsU0FBUyxxQkFBcUIsQ0FBQyxTQUF5QixFQUFFLFVBQWtCLEVBQUUsVUFBeUIsRUFBRSxXQUFvQjtJQUN6SCxNQUFNLE1BQU0sR0FBb0I7UUFDNUIsVUFBVSxFQUFFLFVBQVU7UUFDdEIsVUFBVSxFQUFFLFVBQVU7S0FDekIsQ0FBQztJQUNGLElBQUksU0FBUyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ3JCLE1BQU0sQ0FBQyxRQUFRLEdBQUcsU0FBUyxDQUFDLFFBQVEsQ0FBQztJQUN6QyxDQUFDO0lBQ0QsSUFBSSxXQUFXLEVBQUUsQ0FBQztRQUNkLE1BQU0sQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO0lBQ3JDLENBQUM7SUFDRCxPQUFPLE1BQU0sQ0FBQztBQUNsQixDQUFDO0FBR0QsTUFBYSxtQkFBbUI7SUFPNUIsWUFB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N0YsS0FBSyxFQUFFLG1CQUFtQjtTQUM3QixDQUFDLENBQUM7UUFFSCxPQUFPLDJCQUEyQixDQUFDO0lBQ3ZDLENBQUM7Q0FDSjtBQTNKRCxrREEySkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTZXJ2aWNlQWNjb3VudCB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1la3MnO1xuaW1wb3J0IHsgSVNlY3JldCB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1zZWNyZXRzbWFuYWdlcic7XG5pbXBvcnQgeyBJU3RyaW5nUGFyYW1ldGVyIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLXNzbSc7XG5pbXBvcnQgeyBDZm5PdXRwdXQgfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0ICogYXMgYXNzZXJ0IGZyb20gXCJhc3NlcnRcIjtcbmltcG9ydCB7IFNlY3JldHNTdG9yZUFkZE9uIH0gZnJvbSAnLi4vLi4nO1xuaW1wb3J0IHsgQ2x1c3RlckluZm8sIFZhbHVlcyB9IGZyb20gJy4uLy4uL3NwaSc7XG5pbXBvcnQgeyBTZWNyZXRQcm92aWRlciB9IGZyb20gJy4vc2VjcmV0LXByb3ZpZGVyJztcblxuLyoqXG4gKiBDc2lTZWNyZXQgUHJvcHNcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBDc2lTZWNyZXRQcm9wcyB7XG4gICAgLyoqXG4gICAgICogSW1wbGVtZW50YXRpb24gb2YgdGhlIHNlY3JldCBwcm92aWRlciB0aGF0IHJldHVybnMgYSByZWZlcmVuY2UgdG8gYW4gU2VjcmV0cyBNYW5hZ2VyIGVudHJ5IG9yIEJsdWVwcmludHMgUGFyYW1ldGVyLlxuICAgICAqL1xuICAgIHNlY3JldFByb3ZpZGVyOiBTZWNyZXRQcm92aWRlcjtcblxuICAgIC8qKlxuICAgICAqIEZvciBzZWNyZXRzIGNvbnRhaW5pbmcgSlNPTiBzdHJ1Y3R1cmUsIGFuIG9wdGlvbmFsIEpNRVMgUGF0aCAoaHR0cHM6Ly9qbWVzcGF0aC5vcmcvKSBvYmplY3QgdG8gZGVjb21wb3NlIGluZGl2aWR1YWwga2V5cyBhcyBzZXBhcmF0ZVxuICAgICAqIHNlY3JldCBvYmplY3QgZGF0YS5cbiAgICAgKi9cbiAgICBqbWVzUGF0aD86IEptZXNQYXRoT2JqZWN0W107XG5cbiAgICAvKipcbiAgICAgKiBLdWJlcm5ldGVzIHNlY3JldCBmb3IgY2FzZXMgd2hlbiBDU0kgc2VjcmV0IHNob3VsZCBjcmVhdGUgYSBzdGFuZGFyZCBLdWJlcm5ldGVzIFNlY3JldCBvYmplY3QuXG4gICAgICovXG4gICAga3ViZXJuZXRlc1NlY3JldD86IEt1YmVybmV0ZXNTZWNyZXQ7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSm1lc1BhdGhPYmplY3Qge1xuICAgIG9iamVjdEFsaWFzOiBzdHJpbmcsXG4gICAgcGF0aDogc3RyaW5nXG59XG5cbi8qKlxuICogQ29uZmlndXJhdGlvbiBmb3IgS3ViZXJuZXRlcyBTZWNyZXRzXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgS3ViZXJuZXRlc1NlY3JldCB7XG5cbiAgICAvKipcbiAgICAgKiBLdWJlcm5ldGVzIFNlY3JldCBOYW1lXG4gICAgICovXG4gICAgc2VjcmV0TmFtZTogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICogQW4gYWxpYXMgZm9yIHRoZSBBV1Mgc2VjcmV0IG9uY2UgaXQgaXMgc3luY2VkIGFzIGEgS3ViZXJuZXRlcyBzZWNyZXQuXG4gICAgICovXG4gICAgc2VjcmV0QWxpYXM/OiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBUeXBlIG9mIEt1YmVybmV0ZXMgU2VjcmV0XG4gICAgICovXG4gICAgdHlwZT86IEt1YmVybmV0ZXNTZWNyZXRUeXBlXG5cbiAgICAvKipcbiAgICAgKiBTZWNyZXQgTGFiZWxzXG4gICAgICovXG4gICAgbGFiZWxzPzogVmFsdWVzO1xuXG4gICAgLyoqXG4gICAgICogS3ViZXJuZXRlcyBTZWNyZXRPYmplY3QgRGF0YVxuICAgICAqL1xuICAgIGRhdGE/OiBLdWJlcm5ldGVzU2VjcmV0T2JqZWN0RGF0YVtdO1xufVxuXG4vKipcbiAqIERhdGEgZm9yIEt1YmVybmV0ZXMgU2VjcmV0c1xuICovXG5pbnRlcmZhY2UgS3ViZXJuZXRlc1NlY3JldE9iamVjdERhdGEge1xuXG4gICAgLyoqXG4gICAgICogTmFtZSBvZiB0aGUgQVdTIFNlY3JldCB0aGF0IGlzIHN5bmNlZFxuICAgICAqL1xuICAgIG9iamVjdE5hbWU/OiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBLdWJlcm5ldGVzIFNlY3JldCBLZXlcbiAgICAgKi9cbiAgICBrZXk/OiBzdHJpbmc7XG59XG5cbmVudW0gQXdzU2VjcmV0VHlwZSB7XG4gICAgU1NNUEFSQU1FVEVSID0gJ3NzbXBhcmFtZXRlcicsXG4gICAgU0VDUkVUU01BTkFHRVIgPSAnc2VjcmV0c21hbmFnZXInXG59XG5cbmV4cG9ydCBlbnVtIEt1YmVybmV0ZXNTZWNyZXRUeXBlIHtcbiAgICBPUEFRVUUgPSAnT3BhcXVlJyxcbiAgICBCQVNJQ19BVVRIID0gJ2t1YmVybmV0ZXMuaW8vYmFzaWMtYXV0aCcsXG4gICAgVE9LRU4gPSAnYm9vdHN0cmFwLmt1YmVybmV0ZXMuaW8vdG9rZW4nLFxuICAgIERPQ0tFUl9DT05GSUdfSlNPTiA9ICdrdWJlcm5ldGVzLmlvL2RvY2tlcmNvbmZpZ2pzb24nLFxuICAgIERPQ0tFUl9DT05GSUcgPSAna3ViZXJuZXRlcy5pby9kb2NrZXJjZmcnLFxuICAgIFNTSF9BVVRIID0gJ2t1YmVybmV0ZXMuaW8vc3NoLWF1dGgnLFxuICAgIFNFUlZJQ0VfQUNDT1VOVF9UT0tFTiA9ICdrdWJlcm5ldGVzLmlvL3NlcnZpY2UtYWNjb3VudC10b2tlbicsXG4gICAgVExTID0gJ2t1YmVybmV0ZXMuaW8vdGxzJ1xufVxuXG5pbnRlcmZhY2UgUGFyYW1ldGVyT2JqZWN0IHtcbiAgICBvYmplY3ROYW1lOiBzdHJpbmc7XG4gICAgb2JqZWN0VHlwZTogc3RyaW5nO1xuICAgIG9iamVjdEFsaWFzPzogc3RyaW5nO1xuICAgIGptZXNQYXRoPzogSm1lc1BhdGhPYmplY3RbXTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlUGFyYW1ldGVyT2JqZWN0KGNzaVNlY3JldDogQ3NpU2VjcmV0UHJvcHMsIHNlY3JldE5hbWU6IHN0cmluZywgc2VjcmV0VHlwZTogQXdzU2VjcmV0VHlwZSwgc2VjcmV0QWxpYXM/OiBzdHJpbmcpIHtcbiAgICBjb25zdCByZXN1bHQ6IFBhcmFtZXRlck9iamVjdCA9IHtcbiAgICAgICAgb2JqZWN0TmFtZTogc2VjcmV0TmFtZSxcbiAgICAgICAgb2JqZWN0VHlwZTogc2VjcmV0VHlwZSxcbiAgICB9O1xuICAgIGlmIChjc2lTZWNyZXQuam1lc1BhdGgpIHtcbiAgICAgICAgcmVzdWx0LmptZXNQYXRoID0gY3NpU2VjcmV0LmptZXNQYXRoO1xuICAgIH1cbiAgICBpZiAoc2VjcmV0QWxpYXMpIHtcbiAgICAgICAgcmVzdWx0Lm9iamVjdEFsaWFzID0gc2VjcmV0QWxpYXM7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG59XG5cblxuZXhwb3J0IGNsYXNzIFNlY3JldFByb3ZpZGVyQ2xhc3Mge1xuXG4gICAgcHJpdmF0ZSBwYXJhbWV0ZXJPYmplY3RzOiBQYXJhbWV0ZXJPYmplY3RbXTtcbiAgICBwcml2YXRlIGt1YmVybmV0ZXNTZWNyZXRzOiBLdWJlcm5ldGVzU2VjcmV0W107XG4gICAgcHJpdmF0ZSBjc2lTZWNyZXRzOiBDc2lTZWNyZXRQcm9wc1tdO1xuICAgIHByaXZhdGUgc2VjcmV0UHJvdmlkZXJDbGFzc1Byb21pc2U6IFByb21pc2U8Q29uc3RydWN0PjtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgY2x1c3RlckluZm86IENsdXN0ZXJJbmZvLCBwcml2YXRlIHNlcnZpY2VBY2NvdW50OiBTZXJ2aWNlQWNjb3VudCwgcHJpdmF0ZSBzZWNyZXRQcm92aWRlckNsYXNzTmFtZTogc3RyaW5nLCAuLi5jc2lTZWNyZXRzOiBDc2lTZWNyZXRQcm9wc1tdKSB7XG4gICAgICAgIHRoaXMucGFyYW1ldGVyT2JqZWN0cyA9IFtdO1xuICAgICAgICB0aGlzLmt1YmVybmV0ZXNTZWNyZXRzID0gW107XG4gICAgICAgIHRoaXMuY3NpU2VjcmV0cyA9IGNzaVNlY3JldHM7XG4gICAgICAgIHRoaXMuc2VjcmV0UHJvdmlkZXJDbGFzc1Byb21pc2UgPSB0aGlzLnNldHVwU2VjcmV0cygpO1xuICAgIH1cblxuICAgIHB1YmxpYyBhZGREZXBlbmRlbnQoLi4uY29uc3RydWN0czogQ29uc3RydWN0W10pIHtcbiAgICAgICAgdGhpcy5zZWNyZXRQcm92aWRlckNsYXNzUHJvbWlzZS50aGVuKHNlY3JldFByb3ZpZGVyQ2xhc3MgPT4ge1xuICAgICAgICAgICAgY29uc3RydWN0cy5mb3JFYWNoKGRlcGVuZGVudCA9PiBkZXBlbmRlbnQubm9kZS5hZGREZXBlbmRlbmN5KHNlY3JldFByb3ZpZGVyQ2xhc3MpKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogT3B0aW9uYWxseSByZXR1cm5zIHZvbHVtZSBtb3VudHMgZm9yIGEgcG9kIG9yIGhlbG0gY2hhcnQgdGhhdCBzdXBwb3J0cyB2b2x1bWUgbW91bnRzLlxuICAgICAqL1xuICAgIHB1YmxpYyBnZXRWb2x1bWVNb3VudHModm9sdW1lTmFtZTogc3RyaW5nLCBtb3VudFBhdGg/OiBzdHJpbmcpOiBWYWx1ZXMge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgXCJ2b2x1bWVzXCI6IFtcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IHZvbHVtZU5hbWUsXG4gICAgICAgICAgICAgICAgICAgIGNzaToge1xuICAgICAgICAgICAgICAgICAgICAgICAgZHJpdmVyOiBcInNlY3JldHMtc3RvcmUuY3NpLms4cy5pb1wiLFxuICAgICAgICAgICAgICAgICAgICAgICAgcmVhZE9ubHk6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICB2b2x1bWVBdHRyaWJ1dGVzOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VjcmV0UHJvdmlkZXJDbGFzczogdGhpcy5zZWNyZXRQcm92aWRlckNsYXNzTmFtZVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgXSxcbiAgICAgICAgICAgIFwidm9sdW1lTW91bnRzXCI6IFtcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IHZvbHVtZU5hbWUsXG4gICAgICAgICAgICAgICAgICAgIG1vdW50UGF0aDogbW91bnRQYXRoID8/IFwiL21udC9zZWNyZXQtc3RvcmVcIlxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIF1cbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTZXR1cCBDU0kgc2VjcmV0c1xuICAgICAqIEBwYXJhbSBjbHVzdGVySW5mb1xuICAgICAqL1xuICAgIHByb3RlY3RlZCBzZXR1cFNlY3JldHMoKTogUHJvbWlzZTxDb25zdHJ1Y3Q+IHtcbiAgICAgICAgY29uc3Qgc2VjcmV0c0RyaXZlclByb21pc2UgPSB0aGlzLmNsdXN0ZXJJbmZvLmdldFNjaGVkdWxlZEFkZE9uKFNlY3JldHNTdG9yZUFkZE9uLm5hbWUpO1xuICAgICAgICBhc3NlcnQoc2VjcmV0c0RyaXZlclByb21pc2UgIT0gbnVsbCwgJ1NlY3JldHNTdG9yZUFkZE9uIGlzIHJlcXVpcmVkIHRvIHNldHVwIHNlY3JldHMgYnV0IGlzIG5vdCBwcm92aWRlZCBpbiB0aGUgYWRkLW9ucy4nKTtcblxuICAgICAgICB0aGlzLmFkZFBvbGljeVRvU2VydmljZUFjY291bnQoKTtcblxuICAgICAgICAvLyBDcmVhdGUgYW5kIGFwcGx5IFNlY3JldFByb3ZpZGVyQ2xhc3MgbWFuaWZlc3RcbiAgICAgICAgcmV0dXJuIHNlY3JldHNEcml2ZXJQcm9taXNlIS50aGVuKHNlY3JldHNEcml2ZXIgPT5cbiAgICAgICAgICAgIHRoaXMuY3JlYXRlU2VjcmV0UHJvdmlkZXJDbGFzcyhzZWNyZXRzRHJpdmVyISlcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGVzIFNlcnZpY2UgQWNjb3VudCBmb3IgQ1NJIFNlY3JldHMgZHJpdmVyIGFuZCBzZXRzIHVwIHRoZSBJQU0gUG9saWNpZXNcbiAgICAgKiBuZWVkZWQgdG8gYWNjZXNzIHRoZSBBV1MgU2VjcmV0c1xuICAgICAqIEBwYXJhbSBjbHVzdGVySW5mb1xuICAgICAqIEBwYXJhbSBzZXJ2aWNlQWNjb3VudFxuICAgICAqL1xuICAgIHByb3RlY3RlZCBhZGRQb2xpY3lUb1NlcnZpY2VBY2NvdW50KCkge1xuICAgICAgICB0aGlzLmNzaVNlY3JldHMuZm9yRWFjaCgoY3NpU2VjcmV0KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBkYXRhOiBLdWJlcm5ldGVzU2VjcmV0T2JqZWN0RGF0YVtdID0gW107XG4gICAgICAgICAgICBsZXQga3ViZXJuZXRlc1NlY3JldDogS3ViZXJuZXRlc1NlY3JldDtcbiAgICAgICAgICAgIGxldCBzZWNyZXROYW1lOiBzdHJpbmc7XG4gICAgICAgICAgICBjb25zdCBzZWNyZXQ6IElTZWNyZXQgfCBJU3RyaW5nUGFyYW1ldGVyID0gY3NpU2VjcmV0LnNlY3JldFByb3ZpZGVyLnByb3ZpZGUodGhpcy5jbHVzdGVySW5mbyk7XG4gICAgICAgICAgICBjb25zdCBzZWNyZXRBbGlhczogc3RyaW5nIHwgdW5kZWZpbmVkID0gY3NpU2VjcmV0Lmt1YmVybmV0ZXNTZWNyZXQ/LnNlY3JldEFsaWFzO1xuXG4gICAgICAgICAgICBpZiAoT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwoc2VjcmV0LCAnc2VjcmV0QXJuJykpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBzZWNyZXRNYW5hZ2VyU2VjcmV0ID0gc2VjcmV0IGFzIElTZWNyZXQ7XG4gICAgICAgICAgICAgICAgc2VjcmV0TmFtZSA9IHNlY3JldE1hbmFnZXJTZWNyZXQuc2VjcmV0TmFtZTtcbiAgICAgICAgICAgICAgICBjb25zdCBwYXJhbWV0ZXJPYmplY3QgPSBjcmVhdGVQYXJhbWV0ZXJPYmplY3QoY3NpU2VjcmV0LCBzZWNyZXROYW1lLCBBd3NTZWNyZXRUeXBlLlNFQ1JFVFNNQU5BR0VSLCBzZWNyZXRBbGlhcyk7XG4gICAgICAgICAgICAgICAgdGhpcy5wYXJhbWV0ZXJPYmplY3RzLnB1c2gocGFyYW1ldGVyT2JqZWN0KTtcbiAgICAgICAgICAgICAgICBzZWNyZXRNYW5hZ2VyU2VjcmV0LmdyYW50UmVhZCh0aGlzLnNlcnZpY2VBY2NvdW50KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnN0IHNzbVNlY3JldCA9IHNlY3JldCBhcyBJU3RyaW5nUGFyYW1ldGVyO1xuICAgICAgICAgICAgICAgIHNlY3JldE5hbWUgPSBzc21TZWNyZXQucGFyYW1ldGVyTmFtZTtcbiAgICAgICAgICAgICAgICBjb25zdCBwYXJhbWV0ZXJPYmplY3QgPSBjcmVhdGVQYXJhbWV0ZXJPYmplY3QoY3NpU2VjcmV0LCBzZWNyZXROYW1lLCBBd3NTZWNyZXRUeXBlLlNTTVBBUkFNRVRFUiwgc2VjcmV0QWxpYXMpO1xuICAgICAgICAgICAgICAgIHRoaXMucGFyYW1ldGVyT2JqZWN0cy5wdXNoKHBhcmFtZXRlck9iamVjdCk7XG4gICAgICAgICAgICAgICAgc3NtU2VjcmV0LmdyYW50UmVhZCh0aGlzLnNlcnZpY2VBY2NvdW50KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGNzaVNlY3JldC5rdWJlcm5ldGVzU2VjcmV0KSB7XG4gICAgICAgICAgICAgICAgaWYgKGNzaVNlY3JldC5rdWJlcm5ldGVzU2VjcmV0LmRhdGEpIHtcbiAgICAgICAgICAgICAgICAgICAgY3NpU2VjcmV0Lmt1YmVybmV0ZXNTZWNyZXQuZGF0YS5mb3JFYWNoKChpdGVtKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkYXRhT2JqZWN0OiBLdWJlcm5ldGVzU2VjcmV0T2JqZWN0RGF0YSA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmplY3ROYW1lOiBpdGVtLm9iamVjdE5hbWUgPz8gc2VjcmV0TmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXk6IGl0ZW0ua2V5ID8/IHNlY3JldE5hbWVcbiAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhLnB1c2goZGF0YU9iamVjdCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGF0YU9iamVjdDogS3ViZXJuZXRlc1NlY3JldE9iamVjdERhdGEgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBvYmplY3ROYW1lOiBzZWNyZXROYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAga2V5OiBzZWNyZXROYW1lXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIGRhdGEucHVzaChkYXRhT2JqZWN0KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAga3ViZXJuZXRlc1NlY3JldCA9IHtcbiAgICAgICAgICAgICAgICAgICAgc2VjcmV0TmFtZTogY3NpU2VjcmV0Lmt1YmVybmV0ZXNTZWNyZXQuc2VjcmV0TmFtZSxcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogY3NpU2VjcmV0Lmt1YmVybmV0ZXNTZWNyZXQudHlwZSA/PyBLdWJlcm5ldGVzU2VjcmV0VHlwZS5PUEFRVUUsXG4gICAgICAgICAgICAgICAgICAgIGxhYmVsczogY3NpU2VjcmV0Lmt1YmVybmV0ZXNTZWNyZXQubGFiZWxzID8/IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICAgICAgZGF0YSxcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIHRoaXMua3ViZXJuZXRlc1NlY3JldHMucHVzaChrdWJlcm5ldGVzU2VjcmV0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGFuZCBhcHBseSB0aGUgU2VjcmV0UHJvdmlkZXJDbGFzcyBtYW5pZmVzdFxuICAgICAqIEBwYXJhbSBjbHVzdGVySW5mb1xuICAgICAqIEBwYXJhbSBzZXJ2aWNlQWNjb3VudFxuICAgICAqIEBwYXJhbSBjc2lEcml2ZXJcbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgY3JlYXRlU2VjcmV0UHJvdmlkZXJDbGFzcyhjc2lEcml2ZXI6IENvbnN0cnVjdCk6IENvbnN0cnVjdCB7XG4gICAgICAgIGNvbnN0IGNsdXN0ZXIgPSB0aGlzLmNsdXN0ZXJJbmZvLmNsdXN0ZXI7XG4gICAgICAgIGNvbnN0IHNlY3JldFByb3ZpZGVyQ2xhc3MgPSB0aGlzLnNlY3JldFByb3ZpZGVyQ2xhc3NOYW1lO1xuICAgICAgICBjb25zdCBzZWNyZXRQcm92aWRlckNsYXNzTWFuaWZlc3QgPSBjbHVzdGVyLmFkZE1hbmlmZXN0KHNlY3JldFByb3ZpZGVyQ2xhc3MsIHtcbiAgICAgICAgICAgIGFwaVZlcnNpb246ICdzZWNyZXRzLXN0b3JlLmNzaS54LWs4cy5pby92MWFscGhhMScsXG4gICAgICAgICAgICBraW5kOiAnU2VjcmV0UHJvdmlkZXJDbGFzcycsXG4gICAgICAgICAgICBtZXRhZGF0YToge1xuICAgICAgICAgICAgICAgIG5hbWU6IHNlY3JldFByb3ZpZGVyQ2xhc3MsXG4gICAgICAgICAgICAgICAgbmFtZXNwYWNlOiB0aGlzLnNlcnZpY2VBY2NvdW50LnNlcnZpY2VBY2NvdW50TmFtZXNwYWNlXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgc3BlYzoge1xuICAgICAgICAgICAgICAgIHByb3ZpZGVyOiAnYXdzJyxcbiAgICAgICAgICAgICAgICBwYXJhbWV0ZXJzOiB7XG4gICAgICAgICAgICAgICAgICAgIG9iamVjdHM6IEpTT04uc3RyaW5naWZ5KHRoaXMucGFyYW1ldGVyT2JqZWN0cyksXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBzZWNyZXRPYmplY3RzOiB0aGlzLmt1YmVybmV0ZXNTZWNyZXRzXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHNlY3JldFByb3ZpZGVyQ2xhc3NNYW5pZmVzdC5ub2RlLmFkZERlcGVuZGVuY3koXG4gICAgICAgICAgICB0aGlzLnNlcnZpY2VBY2NvdW50LFxuICAgICAgICAgICAgY3NpRHJpdmVyXG4gICAgICAgICk7XG5cbiAgICAgICAgbmV3IENmbk91dHB1dChjbHVzdGVyLnN0YWNrLCBgJHt0aGlzLnNlcnZpY2VBY2NvdW50LnNlcnZpY2VBY2NvdW50TmFtZX0tc2VjcmV0LXByb3ZpZGVyLWNsYXNzIGAsIHtcbiAgICAgICAgICAgIHZhbHVlOiBzZWNyZXRQcm92aWRlckNsYXNzXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBzZWNyZXRQcm92aWRlckNsYXNzTWFuaWZlc3Q7XG4gICAgfVxufVxuIl19